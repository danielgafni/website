<!doctype html><html data-theme=dark lang=en><head><meta charset=UTF-8><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com giscus.app;connect-src 'self';script-src 'self'  giscus.app 'self'" http-equiv=Content-Security-Policy><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://danielgafni.github.io/website/pr-preview/pr-23 name=base><title>~/danielgafni ‚Ä¢ Cracking The Python Monorepo</title><link href=https://danielgafni.github.io/website/pr-preview/pr-23/favicon.png rel=icon type=image/png><link title="~/danielgafni - Atom Feed" href=https://danielgafni.github.io/website/pr-preview/pr-23/atom.xml rel=alternate type=application/atom+xml><link href="https://danielgafni.github.io/website/pr-preview/pr-23/custom_subset.css?h=0b9535a28bc3d5bf2321" rel=stylesheet><link href="https://danielgafni.github.io/website/pr-preview/pr-23/main.css?h=fa464346b37e382872db" rel=stylesheet><link href="https://danielgafni.github.io/website/pr-preview/pr-23/css/custom.css?h=7fe8dfcff380400d5ebc" rel=stylesheet><link href="https://danielgafni.github.io/website/pr-preview/pr-23/skins/catppuccin.css?h=ddda112c1cfca66427b5" rel=stylesheet><meta content="light dark" name=color-scheme><meta media="(prefers-color-scheme: light)" content=#7287fd name=theme-color><meta media="(prefers-color-scheme: dark)" content=#81c8be name=theme-color><meta name=description><meta property=og:description><meta content="Cracking The Python Monorepo" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale><meta content=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/ property=og:url><meta content=~/danielgafni property=og:site_name><noscript><link href=https://danielgafni.github.io/website/pr-preview/pr-23/no_js.css rel=stylesheet></noscript><script src=https://danielgafni.github.io/website/pr-preview/pr-23/js/initializeTheme.min.js></script><script defer src=https://danielgafni.github.io/website/pr-preview/pr-23/js/themeSwitcher.min.js></script><script src="https://danielgafni.github.io/website/pr-preview/pr-23/search_index.en.js?h=19b43bcbb2682f25ac0d" defer></script><script src="https://danielgafni.github.io/website/pr-preview/pr-23/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://danielgafni.github.io/website/pr-preview/pr-23>~/danielgafni</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/>/blog </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-23/archive/>/archive </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-23/tags/>/tags </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-23/projects/>/projects </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-23/about/>/about </a><li class=menu-icons-container><ul class=menu-icons-group><li class="js menu-icon"><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></ul></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Cracking The Python Monorepo</h1><ul class=meta><li class=draft-label>DRAFT<li>20th Feb 2025<li title="3564 words"><span aria-hidden=true class=separator>‚Ä¢</span>18 min read<li class=tag><span aria-hidden=true class=separator>‚Ä¢</span>Tags:¬†<li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-23/tags/python/>Python</a>,¬†<li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-23/tags/dagger/>Dagger</a>,¬†<li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-23/tags/monorepo/>Monorepo</a></ul><div class=toc-container><h3>Table of Contents</h3><ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#many-snake-in-package-scream>Many üêç in üì¶ ? üò±</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#a-brief-history-of-python-packaging>A brief history of Python packaging</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#setting-up-the-monorepo>Setting up the monorepo</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#cache-me-if-you-can>Cache me if you can</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#a-thousand-daggers>A thousand daggers</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#building-the-build-pipeline>Building the build pipeline</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#growing-the-pipeline>Growing the pipeline</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#conclusion>Conclusion</a></ul></div><section class=body><p>A monorepo is a single repository that contains multiple projects. It is a popular way to organize codebases with many coupled components, or at very big companies like Google, Facebook, and Twitter.<p>For a long time, I did not understand the benefits of monorepos. I thought they were used because people could not figure out how to split their codebases into smaller parts.<p>After working at <a href=https://dagster.io>Dagster</a> (on a pretty huge monorepo with more than 140k lines of code and 70+ subprojects), I realized that monorepos can provide a quite pleasant development experience when done right ‚Äî with the right tooling, practices, and of course, the right use case. Monorepos solve a very specific problem: local dependencies between projects force them to be updated together, which eliminates technical debt and ensures all current projects are always compatible with each other.<p>It‚Äôs worth noting that monorepos are not a silver bullet. They have their own set of challenges, mostly the need to build custom tooling and to organize the development workflow. The big tech companies have the resources to build and maintain these tools, but for smaller companies, it can be quite challenging.<p>Dagster‚Äôs monorepo wasn‚Äôt perfect either. Some of the drawbacks were:<ul><li>slow CI/CD pipelines ‚Äî our builds could run for hours!<li>legacy Python packaging made maintaining dependencies and CI pipelines quite complicated. Making a change to dependencies required editing multiple configuration files carefully.</ul><div class="admonition note"><div class="admonition-icon admonition-icon-note"></div><div class=admonition-content><strong class=admonition-title>NOTE</strong><p>I started migrating Dagster‚Äôs monorepo to <code>uv</code> but at the time got <a href=https://github.com/dagster-io/dagster/pull/23814#issuecomment-2364694200>blocked</a> by the fact that we had conflicting development dependencies for different test suites. This blocker is now resolved as <code>uv</code> now supports conflicting development dependency groups.</div></div><p>That‚Äôs why this post focuses on a very specific use case ‚Äî Python monorepos. Until very recently, Python monorepos were quite hard to set up and maintain. However, nowadays we have a bunch of excellent tooling available with great out-of-the-box monorepo support.<p>In this post, I am going to share an approach to Python monorepos that solves these issues in a very elegant way. This approach offers:<ul><li>integration/compatibility with any <code>uv</code> project<li>little to zero maintenance and boilerplate</ul><p>We will walk through a typical monorepo setup and use <a href=https://astral.sh/uv>uv</a> and <a href=https://dagger.io>Dagger</a> to build lightning-fast and modular build pipelines. Feel free to check out the docs for these tools (<a href=https://docs.astral.sh/uv/getting-started/>uv quickstart</a>, <a href=https://docs.dagger.io/quickstart/daggerize>Dagger quickstart</a>). Impatient readers can jump straight to the <a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#a-thousand-daggers>Dagger module</a>.<div class="admonition warning"><div class="admonition-icon admonition-icon-warning"></div><div class=admonition-content><strong class=admonition-title>WARNING</strong><p><code>uv</code> shouldn‚Äôt need any introduction. In 2024, <code>uv</code> took the Python ecosystem by storm, and it‚Äôs now the go-to tool for Python development. Using anything else (perhaps except <a href=https://pixi.sh/latest/>Pixi</a> which kinda expands <code>uv</code> to the Conda ecosystem) sounds like a joke to me. If the reader did not hear about <code>uv</code>, that‚Äôs a strong hint that they have been living in a cave or another constrained environment for the last year.</div></div><h1 id=many-snake-in-package-scream><a aria-label="Anchor link for: many-snake-in-package-scream" class="header-anchor no-hover-padding" href=#many-snake-in-package-scream><span aria-hidden=true class=link-icon></span></a> Many üêç in üì¶ ? üò±</h1><p>Please look at the emojis above until you get it. Yes, managing packaging in a Python monorepo can be a nightmare. But!<p>It‚Äôs really not with the right tooling.<ul><li><code>uv</code> has the concept of <a href=https://astral.sh/uv/docs/workspaces>workspaces</a> which allows installing individual packages from a monorepo and makes managing dependencies a breeze. It standardizes dependency management and maintenance operations in monorepos, including local dependencies.<li><code>Dagger</code> ‚Äî a universal build tool which supports multiple languages (including Python) to define containerized build pipelines. Because Dagger pipelines can be written in Python, they can be easily adapted to work with monorepos of arbitrary complexity and structure. Dagger is essentially a glorified Dockerfile generator available in your favorite programming language. Dagger pipelines are huge graphs of <code>BuildKit</code> (the engine used by Docker when building images) steps, so the entire pipeline can be optimized, parallelized, and cached by BuildKit.<li>modern linting tooling like <code>ruff</code> and <code>pyright</code> has first-class support for monorepos and is able to automatically discover and merge configuration files from multiple subprojects.</ul><h1 id=a-brief-history-of-python-packaging><a aria-label="Anchor link for: a-brief-history-of-python-packaging" class="header-anchor no-hover-padding" href=#a-brief-history-of-python-packaging><span aria-hidden=true class=link-icon></span></a> A brief history of Python packaging</h1><p>Contrary to what you might think, Python packaging is not a nightmare anymore. It used to be, but with the introduction of <a href=https://peps.python.org/pep-0517/>PEP 517</a> and <a href=https://peps.python.org/pep-0518/>PEP 518</a>, and the rise of <code>uv</code>, it‚Äôs actually in pretty good shape ‚Äî I rarely have to pull out my hair when working with Python packaging nowadays.<p>The PEPs and their adoption were important to standardize the way Python packages are built and distributed. Since the overwhelming majority of Python packages now provide correct distribution metadata (like hashes of the package contents), it‚Äôs much easier for advanced and optimized package managers like <code>uv</code> to do their job really well. Some machine learning dependencies ‚Äî and <a href=https://github.com/pytorch/pytorch/issues/76557>specifically pytorch</a> ‚Äî used to sabotage the Python packaging ecosystem, but even PyTorch now (mostly) provides the hashes with the various wheels they build for all these CUDA versions.<p>Therefore, I‚Äôd like to note that the improvements with packaging are not only due to better tooling like <code>uv</code>, but also due to the community‚Äôs effort to standardize and improve the Python packaging ecosystem in general.<h1 id=setting-up-the-monorepo><a aria-label="Anchor link for: setting-up-the-monorepo" class="header-anchor no-hover-padding" href=#setting-up-the-monorepo><span aria-hidden=true class=link-icon></span></a> Setting up the monorepo</h1><p>Fair enough! Let‚Äôs start by invoking <code>uv</code> (assuming the dear reader has ‚Äî and he should ‚Äî <code>uv</code> installed) and creating a new workspace:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">mkdir uv-dagger-dream
</span><span class="z-text z-plain">cd uv-dagger-dream
</span><span class="z-text z-plain">uv init
</span><span class="z-text z-plain">uv add --group dev ruff pyright
</span><span class="z-text z-plain">mkdir projects
</span><span class="z-text z-plain">uv init --package --lib projects/lib-one
</span><span class="z-text z-plain">uv init --package --lib projects/lib-two
</span><span class="z-text z-plain">uv lock
</span></code></pre><p>Phew! That was a lot of commands. Let‚Äôs break them down:<ul><li><code>uv init</code> initializes a project. A workspace is a directory that contains one or more packages. It‚Äôs a way to group packages together and manage their dependencies, while allowing cross-package dependencies.<li><code>uv add --group dev</code> adds dependencies to the root project. Development groups are only used when working on the project and are not registered as dependencies when the project is published. Downstream projects will not inherit these dependencies.<li><code>uv init --package --lib projects/lib-one</code> initializes a new package in the <code>projects</code> directory. The <code>--lib</code> flag tells <code>uv</code> that this package is a library. This is important because it will add a <code>[build-system]</code> section to the <code>pyproject.toml</code> file, which is required for <code>uv</code> to know how to build the package.<li><code>uv lock</code> creates a <code>uv.lock</code> file that contains the resolved dependencies for the workspace. This file is used by <code>uv</code> to determine which versions of the dependencies to install.</ul><p>After this section, you should see something like this (non-essential files are omitted):<pre class=z-code><code><span class="z-text z-plain">.
</span><span class="z-text z-plain">‚îú‚îÄ‚îÄ README.md
</span><span class="z-text z-plain">‚îú‚îÄ‚îÄ projects
</span><span class="z-text z-plain">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ lib-one
</span><span class="z-text z-plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pyproject.toml
</span><span class="z-text z-plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ src
</span><span class="z-text z-plain">‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ lib_one
</span><span class="z-text z-plain">‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ __init__.py
</span><span class="z-text z-plain">‚îÇ¬†¬† ‚îî‚îÄ‚îÄ lib-two
</span><span class="z-text z-plain">‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ pyproject.toml
</span><span class="z-text z-plain">‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ src
</span><span class="z-text z-plain">‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ lib_two
</span><span class="z-text z-plain">‚îÇ¬†¬†             ‚îî‚îÄ‚îÄ __init__.py
</span><span class="z-text z-plain">‚îú‚îÄ‚îÄ pyproject.toml
</span><span class="z-text z-plain">‚îî‚îÄ‚îÄ uv.lock
</span></code></pre><p>Projects recognized by <code>uv</code> as workspace members share the same <code>uv.lock</code> file, environment, can be added as dependencies to each other, and can be managed with <code>uv</code> commands.<div class="admonition tip"><div class="admonition-icon admonition-icon-tip"></div><div class=admonition-content><strong class=admonition-title>TIP</strong><p>I usually like to edit the root <code>pyproject.toml</code> and set <code>workspace.members</code> to <code>['projects/*']</code> so that all the packages in the <code>projects</code> directory are recognized as workspace members.</div></div><p>To demonstrate how one project can be added as a dependency to another, let‚Äôs add <code>lib-one</code> as a dependency to <code>lib-two</code>:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">uv add --package lib-two lib-one
</span></code></pre><p>The <code>--package</code> flag tells <code>uv</code> to execute the command in the context of the <code>lib-two</code> package. The <code>lib-one</code> package is added as a dependency to <code>lib-two</code>‚Äôs <code>pyproject.toml</code> and the root <code>uv.lock</code> file is updated automatically.<p>See it? We have a monorepo! üéâ<h1 id=cache-me-if-you-can><a aria-label="Anchor link for: cache-me-if-you-can" class="header-anchor no-hover-padding" href=#cache-me-if-you-can><span aria-hidden=true class=link-icon></span></a> Cache me if you can</h1><p>Who knows how to write a <code>Dockerfile</code>? I‚Äôm sure you do. Do you know how to write it efficiently? Are you sure? In any case, we are about to unleash the combined power of <code>Dagger</code> (backed by <code>BuildKit</code>), and <code>uv</code>, to build our monorepo in a very (<strong>very</strong>) efficient way.<p>First, we don‚Äôt actually need a <code>Dockerfile</code>. We could use <code>Dagger</code> to define the entire build process in Python. But since it could somewhat complicate building the project with other tools, we are still going to write a <code>Dockerfile</code>, but:<ol><li>We will define an intermediate stage <em>almost</em> identical to the final stage.<li>We will then call <code>Dagger</code> to build the project in the intermediate stage. We will then complete the final build stage with <code>Dagger</code> in a very efficient way.</ol><p>For simplicity, all the subprojects will share the same <code>Dockerfile</code>. Behold!<details><summary><strong>Click to reveal the Dockerfile</strong></summary> <span class="code-source hidden" data-source=Dockerfile></span> <pre class="language-dockerfile z-code" data-lang=dockerfile><code class=language-dockerfile data-lang=dockerfile><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> options: prod,dev
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ARG </span>INCLUDE_DEPENDENCIES=dev
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ARG </span>PYTHON_VERSION=3.12.8
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">FROM</span> python:<span class="z-entity z-name z-enum z-tag-digest">${PYTHON_VERSION}-slim</span> <span class="z-keyword z-control z-dockerfile">AS</span> <span class="z-variable z-stage-name">base</span>
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ENV </span>DEBIAN_FRONTEND=noninteractive
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> some apt packages usually needed in Python projects
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">RUN </span>--mount=type=cache,target=/var/cache/apt,sharing=locked \
</span><span class="z-source z-dockerfile">    apt-get update && apt-get install -y git curl gcc libpq-dev
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> install uv (https://github.com/astral-sh/uv)
</span></span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> docs for using uv with Docker: https://docs.astral.sh/uv/guides/integration/docker/
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">COPY</span> --from=<span class="z-variable z-stage-name">ghcr.io/astral-sh/uv:0.5.27</span> /uv /bin/uv
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> UV_PROJECT_ENVIRONMENT configures the environment for the uv project interface
</span></span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> UV_PYTHON configures the python executable for the uv pip interface
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ENV </span>UV_PROJECT_ENVIRONMENT=/usr/local/ \
</span><span class="z-source z-dockerfile">    UV_PYTHON=/usr/local/bin/python \
</span><span class="z-source z-dockerfile">    UV_COMPILE_BYTECODE=1 \
</span><span class="z-source z-dockerfile">    UV_LINK_MODE=copy \
</span><span class="z-source z-dockerfile">    UV_FROZEN=1
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">FROM</span> base <span class="z-keyword z-control z-dockerfile">AS</span> <span class="z-variable z-stage-name">deps-prod</span>
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">WORKDIR </span>/src
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">COPY</span> pyproject.toml uv.lock  ./
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ARG </span>PACKAGE
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">RUN </span>--mount=type=cache,target=/root/.cache/uv \
</span><span class="z-source z-dockerfile">    uv sync --no-install-workspace --all-extras --no-dev --package $PACKAGE
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">FROM</span> deps-prod <span class="z-keyword z-control z-dockerfile">AS</span> <span class="z-variable z-stage-name">deps-dev</span>
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ARG </span>PACKAGE
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">RUN </span>--mount=type=cache,target=/root/.cache/uv \
</span><span class="z-source z-dockerfile">    uv sync --no-install-workspace --only-group dev --inexact && \
</span><span class="z-source z-dockerfile">    uv sync --no-install-workspace --all-extras --inexact --package $PACKAGE
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> -------------------------------------------------------------
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">FROM</span> deps-${INCLUDE_DEPENDENCIES} <span class="z-keyword z-control z-dockerfile">AS</span> <span class="z-variable z-stage-name">final</span>
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ARG </span>PACKAGE
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> Copy all the rest of the code
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">COPY</span> . .
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> finally install our code
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">RUN </span>uv sync --all-extras --inexact --package $PACKAGE
</span></code></pre></details><p>That‚Äôs a lot of Docker magic! Let‚Äôs break it down:<ul><li>The <code>deps-prod</code> stage installs only production dependencies. This is useful for building the final image.<li>The <code>deps-dev</code> stage installs development dependencies. This is useful for building an image for QA checks or running tests.<li>The <code>final</code> stage installs the package itself. Only at this point the source code is copied into the image. The last <code>uv sync</code> invocation doesn‚Äôt install any third-party dependencies, only the dependencies from our monorepo (<code>uv</code> workspace). Noticed the <code>--no-install-workspace</code> flag spammed all over the place? It‚Äôs quite important as it enables the previous <code>uv sync</code> command to ignore the missing source code and install only the dependencies.</ul><div class="admonition info"><div class="admonition-icon admonition-icon-info"></div><div class=admonition-content><strong class=admonition-title>INFO</strong><p>The <code>--mount=type=cache,target=/root/.cache/uv</code> flag tells Docker to mount the cache directory to the build container. This way, the cache is persisted between builds and doesn‚Äôt inflate the image itself.</div></div><p>What a great Dockerfile! It‚Äôs so efficient that it‚Äôs almost a crime. Or is it not? Can you spot the problem?<p>Let‚Äôs have a hypothetical conversation between you (the dear reader) and me (the Docker guru): ‚Äì You: Hey, I know! Just look at that filthy <code>COPY . .</code> before the final <code>uv sync</code>! It will invalidate the cache every time any file in the monorepo changes! ‚Äì Docker guru: You are right! But how can we fix it? ‚Äì You: Oh, I‚Äôm very smart. Let‚Äôs fake our package‚Äôs source code with a dummy empty directory, then <code>uv sync</code> it, and only then copy the real source code. Check this out!<pre class="language-dockerfile z-code" data-lang=dockerfile><code class=language-dockerfile data-lang=dockerfile><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> -------------------------------------------------------------
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">FROM</span> deps-${INCLUDE_DEPENDENCIES} <span class="z-keyword z-control z-dockerfile">AS</span> <span class="z-variable z-stage-name">final</span>
</span><span class="z-source z-dockerfile">
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ARG </span>PACKAGE
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">ARG </span>PACKAGE_NAME
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">COPY</span> projects/$PACKAGE/pyproject.toml ./projects/$PACKAGE/
</span><span class="z-source z-dockerfile"><span class="z-comment z-dockerfile"><span class="z-punctuation z-definition z-comment z-dockerfile">#</span> yeah a default uv package needs README.md to be built
</span></span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">RUN </span>mkdir -p projects/$PACKAGE/src/$PACKAGE_NAME && \
</span><span class="z-source z-dockerfile">    touch projects/$PACKAGE/src/$PACKAGE_NAME/__init__.py && \
</span><span class="z-source z-dockerfile">    touch projects/$PACKAGE/README.md
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">RUN </span>uv sync --all-extras --inexact --package $PACKAGE
</span><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">COPY</span> . .
</span></code></pre><p>‚Äì Docker guru: Wow! You are a genius! This way, the cache will be invalidated only when the <code>pyproject.toml</code> file changes. And since the <code>pyproject.toml</code> file is quite stable, the cache will be invalidated only when the dependencies change. But what if our package depends on some other package in the monorepo?<p>‚Äì You: Oh, that‚Äôs easy! We can just copy it before running <code>uv sync</code>.<p>‚Äì Docker guru: Oh and what if we have multiple packages that depend on each other? Are you going to write a new <code>COPY</code> instruction for each of them? Are you going to maintain a separate <code>Dockerfile</code> for each set of dependencies? What if they are scattered around the repo and hard to track? Did you know that OCI images currently have an effective limit of <a href=https://github.com/docker/docs/issues/8230>127 layers per image</a>?<div class="admonition note"><div class="admonition-icon admonition-icon-note"></div><div class=admonition-content><strong class=admonition-title>NOTE</strong><p>This limitation will not be address in this blobpost, but it should be pretty easy to come up with a Dagger work-around for it ‚Äî for example, to use intermediate containers.</div></div><p>‚Äì Again me: By the way, the <code>COPY . .</code> is cursed anyway. It will still cause a rebuild for the final image every time any file in the monorepo changes. Not that this is an issue on its own (copying the source code and running <code>uv sync</code> for editable dependencies is extremely fast), but what if you have a downstream step in your CI pipeline like running expensive tests? Now your pipeline is doomed to be slow and you personally are in trouble.<p>I am sorry for this little drama and displaying myself as <em>‚ÄúDocker guru‚Äù</em> ‚Äî that was cringe but I won‚Äôt untype it.<p>But it‚Äôs true. <strong>This Dockerfile is cursed</strong>. This problem can‚Äôt be solved with Docker in a clean and easy way.<p>Our goal here should be avoiding unnecessary rebuilds of the final image and granularly include only the source code of the packages that are actually needed.<p>What if we could programmatically define the Dockerfile? What if we could define the build process in Python? What if there is already a place in our project where the local dependencies graph is defined precisely?<p>Think about it for a moment. I will give you a hint: it‚Äôs the <label class=spoiler-container><input aria-pressed=false class=spoiler-toggle id=spoiler-96748 role=button type=checkbox> <span title="reveal spoiler" class=spoiler-content tabindex=0> <span class=spoiler-hidden><code>uv.lock</code> file. </span> </span></label> . That wasn‚Äôt a hint, that was the answer.<h1 id=a-thousand-daggers><a aria-label="Anchor link for: a-thousand-daggers" class="header-anchor no-hover-padding" href=#a-thousand-daggers><span aria-hidden=true class=link-icon></span></a> A thousand daggers</h1><p>Let‚Äôs look into the <code>uv.lock</code> file for a moment. It‚Äôs a TOML file that describes the entire dependency tree of our monorepo. At the very top, you will find:<pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">manifest</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">members</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>lib-one<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>lib-two<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml">    <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>uv-dagger-dream<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-array z-begin z-toml">[[</span><span class="z-meta z-tag z-table z-array z-toml"><span class="z-entity z-name z-table z-toml">package</span></span><span class="z-punctuation z-definition z-table z-array z-end z-toml">]]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">name</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>lib-one<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>0.1.0<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">source</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-inline-table z-begin z-toml">{</span> <span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">editable</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>projects/lib-one<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span> <span class="z-punctuation z-definition z-inline-table z-end z-toml">}</span>
</span><span class="z-source z-toml">
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-array z-begin z-toml">[[</span><span class="z-meta z-tag z-table z-array z-toml"><span class="z-entity z-name z-table z-toml">package</span></span><span class="z-punctuation z-definition z-table z-array z-end z-toml">]]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">name</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>lib-two<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>0.1.0<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">source</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-inline-table z-begin z-toml">{</span> <span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">editable</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>projects/lib-two<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span> <span class="z-punctuation z-definition z-inline-table z-end z-toml">}</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">dependencies</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span>
</span><span class="z-source z-toml">    <span class="z-punctuation z-definition z-inline-table z-begin z-toml">{</span> <span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">name</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>lib-one<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span> <span class="z-punctuation z-definition z-inline-table z-end z-toml">}</span><span class="z-punctuation z-separator z-array z-toml">,</span>
</span><span class="z-source z-toml"><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span></code></pre><p>üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ üéâ<p>The very first line of the <code>uv.lock</code> file is the <code>members</code> key. It contains a list of all the workspace members (our local packages), including the root package.<p>Next comes the <code>package</code> array. Each element in the <code>package</code> array describes a package (local or third-party) in the monorepo. Notice the <code>source</code> key in the <code>package</code> table. It points to the source code of the package. And we can use it to identify the local dependencies of a given package.<p>The plan:<ol><li>build the original <code>Dockerfile</code> up to the <code>deps-prod</code> stage. At this point, we have all the production dependencies installed, but the source code is not copied and installed yet.<li>extract the information about the local dependencies from the <code>uv.lock</code> file (with Python)<li>use it to copy the source code of each local dependency into the image<li>then we can run <code>uv sync</code> to install the local dependencies (including our project) in editable mode<li>finally, we can granularly copy the source code of each local dependency</ol><p>Docker can‚Äôt cover steps 2, 3 and 5. But Dagger can! Let‚Äôs write a <code>Dagger</code> function to do this.<div class="admonition note"><div class="admonition-icon admonition-icon-note"></div><div class=admonition-content><strong class=admonition-title>NOTE</strong><p>The words <code>container</code> and <code>image</code> are used interchangeably in this post. Technically, a container is a running instance of an image, but Dagger defines the <code>Container</code> type, so I will use the word <code>container</code> to refer to images most of the time.</div></div><p>We will start by creating a new <code>Dagger</code> module sitting in a separate package in our monorepo. This way we keep it independent and reusable.<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">mkdir .dagger
</span><span class="z-text z-plain">cd .dagger
</span><span class="z-text z-plain">dagger init --sdk python --name monorepo-dagger .dagger
</span></code></pre><p>This command will create a new <code>Dagger</code> module in the <code>.dagger</code> directory.<p>The Dagger package we just added is not configured to be a workspace member because of <a href=https://github.com/dagger/dagger/issues/8583#issuecomment-2654117616>this</a> current limitation of Dagger (this may already be fixed at the time of reading). It also relies on an ephemeral local <code>sdk</code> package which is excluded from version control and may not be always available for <code>uv</code>.<p>Here are the steps for a workaround at the time of writing:<ol><li>Remove the following from <code>.dagger/pyproject.toml</code>:</ol><pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">tool</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">uv</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">sources</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">dagger-io</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-inline-table z-begin z-toml">{</span> <span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">path</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>sdk<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-separator z-inline-table z-toml">,</span> <span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">editable</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-constant z-language z-toml">true</span> <span class="z-punctuation z-definition z-inline-table z-end z-toml">}</span>
</span></code></pre><p>and run <code>uv add tomli</code> (we will use it to read <code>uv.lock</code>) inside the <code>.dagger</code> directory.<p>This will ensure that the Dagger module is not dependent on the local <code>sdk</code> package and will fetch <code>dagger-io</code> from PyPI instead.<ol start=2><li>Add the Dagger module as a development dependency to the root project:</ol><pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">uv add --group dagger .dagger
</span><span class="z-text z-plain">uv sync --all-groups
</span></code></pre><p>This will enable type checking and linting for our Dagger module.<ol start=3><li>Move <code>dagger.json</code> to the repo root, and add</ol><pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>source<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>: <span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>.dagger<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>
</span></code></pre><p>to it.<ol start=4><li>Finally, add</ol><pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">project</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">entry-points</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>dagger.mod<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">main_object</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>monorepo_dagger:MonorepoDagger<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span></code></pre><p>to the root <code>pyproject.toml</code>.<p>Now we can run the <code>dagger call</code> command from the repo root.<h1 id=building-the-build-pipeline><a aria-label="Anchor link for: building-the-build-pipeline" class="header-anchor no-hover-padding" href=#building-the-build-pipeline><span aria-hidden=true class=link-icon></span></a> Building the build pipeline</h1><p>We will go backwards since it‚Äôs somewhat easier to understand in my opinion. Feel free to consult the Dagger Python SDK <a href=https://dagger-io.readthedocs.io/en/sdk-python-v0.16.1/>documentation</a>.<p>First, we will do a bunch of imports and define some useful types:</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-from z-python">from</span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-import-source z-python"> <span class="z-meta z-import-path z-python"><span class="z-meta z-import-name z-python">typing</span></span> <span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span></span></span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-statement z-import z-python"> <span class="z-punctuation z-section z-import-list z-begin z-python">(</span></span></span><span class="z-meta z-statement z-import z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">Annotated</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">TypeAlias</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-punctuation z-section z-import-list z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dagger</span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">tomli</span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-from z-python">from</span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-import-source z-python"> <span class="z-meta z-import-path z-python"><span class="z-meta z-import-name z-python">dagger</span></span> <span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span></span></span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-statement z-import z-python"> <span class="z-punctuation z-section z-import-list z-begin z-python">(</span></span></span><span class="z-meta z-statement z-import z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">BuildArg</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">Container</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">DefaultPath</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">File</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">Ignore</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">dag</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">function</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">object_type</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-punctuation z-section z-import-list z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">IGNORE</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Ignore</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.env<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.git<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**/.venv<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**__pycache__**<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.dagger/sdk<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**/.pytest_cache<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**/.ruff_cache<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">    <span class="z-punctuation z-section z-sequence z-end z-python">]</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> this represents the repo root
</span></span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">RootDir</span></span><span class="z-punctuation z-separator z-annotation z-variable z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">TypeAlias</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Annotated</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dagger</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">Directory</span></span>,
</span></span><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">DefaultPath</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>,
</span></span><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">IGNORE</span></span>,
</span></span><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python"></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> this represents the source directory of a specific project in the monorepo
</span></span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">SourceDir</span></span><span class="z-punctuation z-separator z-annotation z-variable z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">TypeAlias</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Annotated</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dagger</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">Directory</span></span>,
</span></span><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">IGNORE</span></span>,
</span></span><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python"></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span>
</span></code></pre><hr><p>And here is the Dagger entry point ‚Äî <code>MonorepoDagger</code>, also called a Dagger <em>Module</em>. The method <code>build_project</code> defines a Dagger <em>Function</em> which will be available as<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">dagger call build-project
</span></code></pre><p>from the command line. The <code>build_project</code> function will build the Docker image for a given project and will <strong>only contain the dependencies and source code required for that project</strong>. This function will call other high-level methods of the class to achieve this.</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">object_type</span></span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-class z-python"><span class="z-storage z-type z-class z-python"><span class="z-keyword z-declaration z-class z-python">class</span></span> <span class="z-entity z-name z-class z-python"><span class="z-meta z-generic-name z-python">MonorepoDagger</span></span><span class="z-punctuation z-section z-class z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">function</span></span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">build_project</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">root_dir</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">RootDir</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">debug_sleep</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">float</span></span> </span><span class="z-meta z-function z-parameters z-default-value z-python"><span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-constant z-numeric z-float z-decimal z-python">0<span class="z-punctuation z-separator z-decimal z-python">.</span>0</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">"""</span>Build a container containing only the source code for a given project and it's dependencies.<span class="z-punctuation z-definition z-comment z-end z-python">"""</span></span>
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> we start by creating a container including only third-party dependencies
</span></span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> with no source code (except pyproject.toml and uv.lock from the repo root)
</span></span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">container_with_third_party_dependencies</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">pyproject_toml</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pyproject.toml<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">uv_lock</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv.lock<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">dockerfile</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">Dockerfile<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> this could be a parameter
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">project</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> find the source code locations for the dependencies of a given project
</span></span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-keyword z-other z-await z-python">await</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">get_project_sources_map</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv.lock<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">copy_source_code</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_exec</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sleep<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-type z-python">str</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">debug_sleep</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> we run `uv sync` to create editable installs of the local dependencies
</span></span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> pointing (for now) to the dummy directories we created in the previous step
</span></span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">install_local_dependencies</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> change the working directory to the project's source directory
</span></span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> so that commands in CI are automatically run in the context of this project
</span></span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_workdir</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-storage z-type z-string z-python">f</span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python">/src/</span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-begin z-python">{</span><span class="z-source z-python z-embedded"><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span></span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-end z-python">}</span></span><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span>
</span></code></pre><p>The <code>debug_sleep</code> argument will be useful later.<hr><p>Let‚Äôs implement the <code>container_with_third_party_dependencies</code> method first. That‚Äôs easy, we just need to use the existing <code>Dockerfile</code> and specify the <code>deps-dev</code> target stage. Note how we don‚Äôt need <strong>any files</strong> except <code>pyproject.toml</code> and <code>uv.lock</code> to build the Docker image for a given project. This is possible thanks to <code>uv</code> workspaces.</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">container_with_third_party_dependencies</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">pyproject_toml</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">uv_lock</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">dockerfile</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> create an empty directory to make sure only the pyproject.toml
</span></span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> and uv.lock files are copied to the build context (to affect caching)
</span></span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">build_context</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dag</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">directory</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pyproject.toml<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pyproject_toml</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv.lock<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">/Dockerfile<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dockerfile</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_new_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">README.md<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">Dummy README.md<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">        <span class="z-punctuation z-section z-group z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">build_context</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">docker_build</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">target</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">deps-dev<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">dockerfile</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">/Dockerfile<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">build_args</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">BuildArg</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">name</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">PACKAGE<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-variable z-parameter z-python">value</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><div class="admonition note"><div class="admonition-icon admonition-icon-note"></div><div class=admonition-content><strong class=admonition-title>NOTE</strong><p>We also create a dummy <code>README.md</code> file since <code>Hatch</code> ‚Äî the default build system in <code>uv</code> projects ‚Äî requires it to be present.</div></div><hr><p>The <code>project_sources_map</code> dictionary is the precious information we need to enable granular copying of the source code. Here is the implementation of the <code>get_project_sources_map</code> method which retrieves it:</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">get_project_sources_map</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">uv_lock</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span>, <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">"""</span>Returns a dictionary of the local dependencies' (of a given project) source directories.<span class="z-punctuation z-definition z-comment z-end z-python">"""</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">tomli</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">loads</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-keyword z-other z-await z-python">await</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">contents</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">members</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-type z-python">set</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">manifest<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">members<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">local_projects</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-set z-python"><span class="z-punctuation z-section z-set z-begin z-python">{</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-set z-end z-python">}</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> first, find the dependencies of our project
</span></span><span class="z-source z-python">        <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">package</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">package<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><span class="z-source z-python">            <span class="z-meta z-statement z-conditional z-if z-python"><span class="z-keyword z-control z-conditional z-if z-python">if</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-comparison z-python">==</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-block z-conditional z-if z-python">:</span></span>
</span><span class="z-source z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dependencies</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">get</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">dependencies<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-sequence z-list z-empty z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">                <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">dep</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dependencies</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><span class="z-source z-python">                    <span class="z-meta z-statement z-conditional z-if z-python"><span class="z-keyword z-control z-conditional z-if z-python">if</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">isinstance</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dep</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">dict</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-keyword z-operator z-logical z-python">and</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dep</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">get</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-keyword z-operator z-logical z-python">in</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">members</span></span><span class="z-punctuation z-section z-block z-conditional z-if z-python">:</span></span>
</span><span class="z-source z-python">                        <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">local_projects</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">add</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dep</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> now, gather all the directories with the dependency sources
</span></span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-mapping z-empty z-python"><span class="z-punctuation z-section z-mapping z-begin z-python">{</span><span class="z-punctuation z-section z-mapping z-end z-python">}</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">package</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">package<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><span class="z-source z-python">            <span class="z-meta z-statement z-conditional z-if z-python"><span class="z-keyword z-control z-conditional z-if z-python">if</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-logical z-python">in</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">local_projects</span></span><span class="z-punctuation z-section z-block z-conditional z-if z-python">:</span></span>
</span><span class="z-source z-python">                <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">source<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">editable<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span>
</span></code></pre><p>This function will parse the <code>uv.lock</code> file and return a dictionary where the keys are the project names and the values are the paths to the source code.<div class="admonition info"><div class="admonition-icon admonition-icon-info"></div><div class=admonition-content><strong class=admonition-title>INFO</strong><p>Most of the Dagger operations are lazy. The operations which trigger materializations are <code>async</code> and therefore must be explicitly awaited. This is why we use <code>await</code> to fetch the <code>uv.lock</code> file contents. It‚Äôs a very elegant way to express blocking operations, because once part of the code becomes <code>async</code> (blocking), all the code that calls it must also be <code>async</code> (blocking). Smart!</div></div><div class="admonition note"><div class="admonition-icon admonition-icon-note"></div><div class=admonition-content><strong class=admonition-title>NOTE</strong><p>For extra cache efficiency this can be replaced by creating dummy directories and files similar to the <code>Dockerfile</code> trick above, but we will keep it simple for the sake of this blog post.</div></div><hr><p>Our source code is still not copied into the image. Let‚Äôs implement the <code>copy_source_code</code> method which will granularly copy the source code of a given project and its dependencies into the image. This is why we are here!</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">copy_source_code</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">container</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">root_dir</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">RootDir</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project_sources_map</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span>, <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">project</span><span class="z-punctuation z-separator z-target-list z-python">,</span> <span class="z-meta z-generic-name z-python">project_source_path</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">items</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><span class="z-source z-python">            <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_directory</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-storage z-type z-string z-python">f</span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python">/src/</span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-begin z-python">{</span><span class="z-source z-python z-embedded"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_source_path</span></span></span></span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-end z-python">}</span></span><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">directory</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_source_path</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span>
</span></code></pre><hr><p>Now the only thing left is to install the local dependencies in editable mode:</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">install_local_dependencies</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">container</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function z-parameters z-annotation z-python">    </span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> the following uv command installs the project
</span></span><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> and its dependencies in editable mode
</span></span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_exec</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sync<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">--inexact<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">--package<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">            <span class="z-punctuation z-section z-sequence z-end z-python">]</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span>
</span></code></pre><hr><p>All together:<details><summary><strong>Click to reveal the full Dagger module</strong></summary> <span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span> <pre class="language-python z-code" data-lang=python data-linenos><code class=language-python data-lang=python><table><tbody><tr><td>1<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-from z-python">from</span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-import-source z-python"> <span class="z-meta z-import-path z-python"><span class="z-meta z-import-name z-python">typing</span></span> <span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span></span></span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-statement z-import z-python"> <span class="z-punctuation z-section z-import-list z-begin z-python">(</span></span></span><span class="z-meta z-statement z-import z-python">
</span></span><tr><td>2<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">Annotated</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>3<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">TypeAlias</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>4<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-punctuation z-section z-import-list z-end z-python">)</span></span>
</span><tr><td>5<td><span class="z-source z-python">
</span><tr><td>6<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dagger</span></span></span>
</span><tr><td>7<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">tomli</span></span></span>
</span><tr><td>8<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-from z-python">from</span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-import-source z-python"> <span class="z-meta z-import-path z-python"><span class="z-meta z-import-name z-python">dagger</span></span> <span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span></span></span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-statement z-import z-python"> <span class="z-punctuation z-section z-import-list z-begin z-python">(</span></span></span><span class="z-meta z-statement z-import z-python">
</span></span><tr><td>9<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">BuildArg</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>10<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">Container</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>11<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">DefaultPath</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>12<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">File</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>13<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">Ignore</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>14<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">dag</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>15<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">function</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>16<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python">    <span class="z-meta z-generic-name z-python">object_type</span><span class="z-punctuation z-separator z-import-list z-python">,</span>
</span></span><tr><td>17<td><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-punctuation z-section z-import-list z-end z-python">)</span></span>
</span><tr><td>18<td><span class="z-source z-python">
</span><tr><td>19<td><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">IGNORE</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Ignore</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><tr><td>20<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span>
</span></span></span><tr><td>21<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.env<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>22<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.git<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>23<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**/.venv<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>24<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**__pycache__**<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>25<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.dagger/sdk<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>26<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**/.pytest_cache<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>27<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">**/.ruff_cache<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>28<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">    <span class="z-punctuation z-section z-sequence z-end z-python">]</span></span>
</span></span><tr><td>29<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>30<td><span class="z-source z-python">
</span><tr><td>31<td><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> this represents the repo root
</span></span><tr><td>32<td><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">RootDir</span></span><span class="z-punctuation z-separator z-annotation z-variable z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">TypeAlias</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Annotated</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python">
</span></span><tr><td>33<td><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dagger</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">Directory</span></span>,
</span></span><tr><td>34<td><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">DefaultPath</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">.<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>,
</span></span><tr><td>35<td><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">IGNORE</span></span>,
</span></span><tr><td>36<td><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python"></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span>
</span><tr><td>37<td><span class="z-source z-python">
</span><tr><td>38<td><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> this represents the source directory of a specific project in the monorepo
</span></span><tr><td>39<td><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">SourceDir</span></span><span class="z-punctuation z-separator z-annotation z-variable z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">TypeAlias</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Annotated</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python">
</span></span><tr><td>40<td><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dagger</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">Directory</span></span>,
</span></span><tr><td>41<td><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">IGNORE</span></span>,
</span></span><tr><td>42<td><span class="z-source z-python"><span class="z-meta z-item-access z-arguments z-python"></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span>
</span><tr><td>43<td><span class="z-source z-python">
</span><tr><td>44<td><span class="z-source z-python">
</span><tr><td>45<td><span class="z-source z-python"><span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">object_type</span></span></span></span>
</span><tr><td>46<td><span class="z-source z-python"><span class="z-meta z-class z-python"><span class="z-storage z-type z-class z-python"><span class="z-keyword z-declaration z-class z-python">class</span></span> <span class="z-entity z-name z-class z-python"><span class="z-meta z-generic-name z-python">MonorepoDagger</span></span><span class="z-punctuation z-section z-class z-begin z-python">:</span></span>
</span><tr><td>47<td><span class="z-source z-python">    <span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">function</span></span></span></span>
</span><tr><td>48<td><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">build_project</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><tr><td>49<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>50<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">root_dir</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">RootDir</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>51<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>52<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">debug_sleep</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">float</span></span> </span><span class="z-meta z-function z-parameters z-default-value z-python"><span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-constant z-numeric z-float z-decimal z-python">0<span class="z-punctuation z-separator z-decimal z-python">.</span>0</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>53<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><tr><td>54<td><span class="z-source z-python">        <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">"""</span>Build a container containing only the source code for a given project and it's dependencies.<span class="z-punctuation z-definition z-comment z-end z-python">"""</span></span>
</span><tr><td>55<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> we start by creating a container including only third-party dependencies
</span></span><tr><td>56<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> with no source code (except pyproject.toml and uv.lock from the repo root)
</span></span><tr><td>57<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">container_with_third_party_dependencies</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><tr><td>58<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">pyproject_toml</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pyproject.toml<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>59<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">uv_lock</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv.lock<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>60<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">dockerfile</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">Dockerfile<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> this could be a parameter
</span></span></span><tr><td>61<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">project</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>62<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>63<td><span class="z-source z-python">
</span><tr><td>64<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> find the source code locations for the dependencies of a given project
</span></span><tr><td>65<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-keyword z-other z-await z-python">await</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">get_project_sources_map</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><tr><td>66<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv.lock<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span>
</span></span><tr><td>67<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>68<td><span class="z-source z-python">
</span><tr><td>69<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">copy_source_code</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>70<td><span class="z-source z-python">
</span><tr><td>71<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_exec</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sleep<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-type z-python">str</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">debug_sleep</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>72<td><span class="z-source z-python">
</span><tr><td>73<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> we run `uv sync` to create editable installs of the local dependencies
</span></span><tr><td>74<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> pointing (for now) to the dummy directories we created in the previous step
</span></span><tr><td>75<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">install_local_dependencies</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>76<td><span class="z-source z-python">
</span><tr><td>77<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> change the working directory to the project's source directory
</span></span><tr><td>78<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> so that commands in CI are automatically run in the context of this project
</span></span><tr><td>79<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_workdir</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-storage z-type z-string z-python">f</span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python">/src/</span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-begin z-python">{</span><span class="z-source z-python z-embedded"><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span></span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-end z-python">}</span></span><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>80<td><span class="z-source z-python">
</span><tr><td>81<td><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span>
</span><tr><td>82<td><span class="z-source z-python">
</span><tr><td>83<td><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">container_with_third_party_dependencies</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><tr><td>84<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>85<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">pyproject_toml</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>86<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">uv_lock</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>87<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">dockerfile</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>88<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>89<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><tr><td>90<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> create an empty directory to make sure only the pyproject.toml
</span></span><tr><td>91<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> and uv.lock files are copied to the build context (to affect caching)
</span></span><tr><td>92<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">build_context</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span>
</span></span><tr><td>93<td><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dag</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">directory</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><tr><td>94<td><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span></span><tr><td>95<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pyproject.toml<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><tr><td>96<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pyproject_toml</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><tr><td>97<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><tr><td>98<td><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span></span><tr><td>99<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv.lock<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><tr><td>100<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><tr><td>101<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><tr><td>102<td><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span></span><tr><td>103<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">/Dockerfile<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><tr><td>104<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dockerfile</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span></span><tr><td>105<td><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><tr><td>106<td><span class="z-source z-python"><span class="z-meta z-group z-python">            <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_new_file</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">README.md<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">Dummy README.md<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><tr><td>107<td><span class="z-source z-python"><span class="z-meta z-group z-python">        <span class="z-punctuation z-section z-group z-end z-python">)</span></span>
</span><tr><td>108<td><span class="z-source z-python">
</span><tr><td>109<td><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">build_context</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">docker_build</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><tr><td>110<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">target</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">deps-dev<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>111<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">dockerfile</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">/Dockerfile<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>112<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-variable z-parameter z-python">build_args</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">BuildArg</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">name</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">PACKAGE<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-variable z-parameter z-python">value</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>113<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>114<td><span class="z-source z-python">
</span><tr><td>115<td><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">get_project_sources_map</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><tr><td>116<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>117<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">uv_lock</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">File</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>118<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>119<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span>, <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><tr><td>120<td><span class="z-source z-python">        <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">"""</span>Returns a dictionary of the local dependencies' (of a given project) source directories.<span class="z-punctuation z-definition z-comment z-end z-python">"""</span></span>
</span><tr><td>121<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">tomli</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">loads</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-keyword z-other z-await z-python">await</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">contents</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>122<td><span class="z-source z-python">
</span><tr><td>123<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">members</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-type z-python">set</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">manifest<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">members<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>124<td><span class="z-source z-python">
</span><tr><td>125<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">local_projects</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-set z-python"><span class="z-punctuation z-section z-set z-begin z-python">{</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-set z-end z-python">}</span></span>
</span><tr><td>126<td><span class="z-source z-python">
</span><tr><td>127<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> first, find the dependencies of our project
</span></span><tr><td>128<td><span class="z-source z-python">        <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">package</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">package<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><tr><td>129<td><span class="z-source z-python">            <span class="z-meta z-statement z-conditional z-if z-python"><span class="z-keyword z-control z-conditional z-if z-python">if</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-comparison z-python">==</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-block z-conditional z-if z-python">:</span></span>
</span><tr><td>130<td><span class="z-source z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dependencies</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">get</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">dependencies<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-sequence z-list z-empty z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>131<td><span class="z-source z-python">                <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">dep</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dependencies</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><tr><td>132<td><span class="z-source z-python">                    <span class="z-meta z-statement z-conditional z-if z-python"><span class="z-keyword z-control z-conditional z-if z-python">if</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">isinstance</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dep</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">dict</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-keyword z-operator z-logical z-python">and</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dep</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">get</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-keyword z-operator z-logical z-python">in</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">members</span></span><span class="z-punctuation z-section z-block z-conditional z-if z-python">:</span></span>
</span><tr><td>133<td><span class="z-source z-python">                        <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">local_projects</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">add</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dep</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>134<td><span class="z-source z-python">
</span><tr><td>135<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> now, gather all the directories with the dependency sources
</span></span><tr><td>136<td><span class="z-source z-python">
</span><tr><td>137<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-mapping z-empty z-python"><span class="z-punctuation z-section z-mapping z-begin z-python">{</span><span class="z-punctuation z-section z-mapping z-end z-python">}</span></span>
</span><tr><td>138<td><span class="z-source z-python">
</span><tr><td>139<td><span class="z-source z-python">        <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">package</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">uv_lock_dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">package<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><tr><td>140<td><span class="z-source z-python">            <span class="z-meta z-statement z-conditional z-if z-python"><span class="z-keyword z-control z-conditional z-if z-python">if</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-logical z-python">in</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">local_projects</span></span><span class="z-punctuation z-section z-block z-conditional z-if z-python">:</span></span>
</span><tr><td>141<td><span class="z-source z-python">                <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">name<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">package</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">source<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">editable<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span>
</span><tr><td>142<td><span class="z-source z-python">
</span><tr><td>143<td><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span>
</span><tr><td>144<td><span class="z-source z-python">
</span><tr><td>145<td><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">copy_source_code</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><tr><td>146<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>147<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">container</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>148<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">root_dir</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">RootDir</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>149<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">project_sources_map</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">dict</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span>, <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
</span></span><tr><td>150<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">    <span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><tr><td>151<td><span class="z-source z-python">        <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">project</span><span class="z-punctuation z-separator z-target-list z-python">,</span> <span class="z-meta z-generic-name z-python">project_source_path</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_sources_map</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">items</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><tr><td>152<td><span class="z-source z-python">            <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_directory</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><tr><td>153<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-storage z-type z-string z-python">f</span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python">/src/</span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-begin z-python">{</span><span class="z-source z-python z-embedded"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_source_path</span></span></span></span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-end z-python">}</span></span><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>154<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">                <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">root_dir</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">directory</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project_source_path</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><tr><td>155<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>156<td><span class="z-source z-python">
</span><tr><td>157<td><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span>
</span><tr><td>158<td><span class="z-source z-python">
</span><tr><td>159<td><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">install_local_dependencies</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python">
</span></span><tr><td>160<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-python">        <span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">container</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span>
</span></span><tr><td>161<td><span class="z-source z-python"><span class="z-meta z-function z-parameters z-annotation z-python">    </span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">Container</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><tr><td>162<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> the following uv command installs the project
</span></span><tr><td>163<td><span class="z-source z-python">        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> and its dependencies in editable mode
</span></span><tr><td>164<td><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_exec</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><tr><td>165<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">            <span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span>
</span></span></span><tr><td>166<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">uv<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>167<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sync<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>168<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">--inexact<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>169<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">--package<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>170<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">                <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-separator z-sequence z-python">,</span>
</span></span></span><tr><td>171<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-meta z-sequence z-list z-python">            <span class="z-punctuation z-section z-sequence z-end z-python">]</span></span>
</span></span><tr><td>172<td><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><tr><td>173<td><span class="z-source z-python">
</span><tr><td>174<td><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span>
</span></table></code></pre></details><p>The beauty of this approach is that we can now take full advantage of:<ul><li><code>uv</code>‚Äôs project discovery<li>the fact that <code>uv</code> workspace configuration is standardized and well-defined<li>and always kept in sync with the actual project structure when running <code>uv</code> commands</ul><p>We can build the Docker image for any project in the monorepo with a single command:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">dagger call build-project --root-dir . --project lib-one
</span></code></pre><p>We can add a project to an arbitrary location in the monorepo, add other projects as dependencies, and build the new project without changing anything:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">uv init --package --lib weird-location/nested/lib-three
</span><span class="z-text z-plain">uv add --package lib-three lib-one lib-two
</span><span class="z-text z-plain">dagger call build-project --root-dir . --project lib-three
</span></code></pre><p>Running <code>dagger call build-project --root-dir . --project lib-three</code> just works despite the <em>weird</em> location of the <code>lib-three</code> project and zero build pipeline changes!<details><summary><strong>Proof</strong></summary> <pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">dagger call build-project --root-dir . --project lib-three
</span><span class="z-text z-plain">‚úî connect 0.2s
</span><span class="z-text z-plain">‚úî load module 5.4s
</span><span class="z-text z-plain">‚úî parsing command line arguments 2.0s
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">‚úî monorepoDagger: MonorepoDagger! 2.1s
</span><span class="z-text z-plain">‚úî .buildProject(
</span><span class="z-text z-plain">‚îÇ ‚îÇ debugSleep: 0.000000
</span><span class="z-text z-plain">‚îÇ ‚îÇ project: "lib-three"
</span><span class="z-text z-plain">‚îÇ ‚îÇ rootDir: no(digest: "sha256:7112225e5254a6bc947b4ce9318d5ed7e8e5a713df2bb1acefa52bbd739077ce"): Missing
</span><span class="z-text z-plain">‚îÇ ): Container! 8.2s
</span><span class="z-text z-plain">‚úî .defaultArgs: [String!]! 0.0s
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">‚úî Container.mounts: [String!]! 0.0s
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">‚úî Container.entrypoint: [String!]! 0.0s
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">‚úî Container.platform: Platform! 0.0s
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">‚úî Container.user: String! 0.0s
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">‚úî Container.workdir: String! 0.0s
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">_type: Container
</span><span class="z-text z-plain">defaultArgs:
</span><span class="z-text z-plain">    - python3
</span><span class="z-text z-plain">entrypoint: []
</span><span class="z-text z-plain">mounts: []
</span><span class="z-text z-plain">platform: linux/amd64
</span><span class="z-text z-plain">user: ""
</span><span class="z-text z-plain">workdir: /src
</span></code></pre></details><p>Now let‚Äôs confirm caching works as expected. <code>lib-one</code> doesn‚Äôt depend on <code>lib-two</code>, so modifying files in <code>lib-two</code> should not invalidate the cache for <code>lib-one</code>. Since Dagger doesn‚Äôt always log the intermediate hash digests, we will use the <code>--debug-sleep</code> flag to check whether the build stage is skipped.<p>The first build:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">dagger call build-project --root-dir . --project lib-one --debug-sleep=5
</span><span class="z-text z-plain">‚úî .buildProject(
</span><span class="z-text z-plain">‚îÇ ‚îÇ debugSleep: 5.000000
</span><span class="z-text z-plain">‚îÇ ‚îÇ project: "lib-one"
</span><span class="z-text z-plain">‚îÇ ‚îÇ rootDir: no(digest: "sha256:e52f8c20e2809532808a5be5d1b0313aa8d18d10766fc902b7a22b0358973109"): Missing
</span><span class="z-text z-plain">‚îÇ ): Container! 9.1s
</span></code></pre><p>Now let‚Äôs change something in <code>lib-two</code> and rebuild <code>lib-one</code>:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">touch projects/lib-two/src/lib_two/new_file.py
</span><span class="z-text z-plain">dagger call build-project --root-dir . --project lib-one --debug-sleep=5
</span><span class="z-text z-plain">‚úî .buildProject(
</span><span class="z-text z-plain">‚îÇ ‚îÇ debugSleep: 5.000000
</span><span class="z-text z-plain">‚îÇ ‚îÇ project: "lib-one"
</span><span class="z-text z-plain">‚îÇ ‚îÇ rootDir: no(digest: "sha256:d1b1986db760ada8081fc3b9ff584ce0c55c006adda7cb324b5f68774bc976e6"): Missing
</span><span class="z-text z-plain">‚îÇ ): Container! 2.6s
</span></code></pre><p>Hooray! The build only took <code>2.6s</code> now ‚Äî the cache has not been invalidated and the build stage has been skipped!<div class="admonition info"><div class="admonition-icon admonition-icon-info"></div><div class=admonition-content><strong class=admonition-title>INFO</strong><p>The build is not fully cached because the <code>--root-dir</code> argument points at the entire repo (which did change). But it doesn‚Äôt matter since the <strong>final</strong> image is cached and the build stage is skipped.</div></div><h1 id=growing-the-pipeline><a aria-label="Anchor link for: growing-the-pipeline" class="header-anchor no-hover-padding" href=#growing-the-pipeline><span aria-hidden=true class=link-icon></span></a> Growing the pipeline</h1><p>Now that we have a Dagger Function which builds a container for a given project, we can easily create downstream steps in our CI pipeline. For example, this is how we can run tests for a project after building the container:</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python">    <span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">function</span></span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">pytest</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">source_dir</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">SourceDir</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">"""</span>Run pytest for a given project.<span class="z-punctuation z-definition z-comment z-end z-python">"""</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">build_project</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">source_dir</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_exec</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pytest<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">stdout</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>Running the tests becomes:<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">dagger call pytest --root-dir . --project lib-one
</span></code></pre><p>Note how we can do it in one function call. Any upstream steps (like building the image) are automatically executed before the tests and are very likely to be cached.<p>Another one with <code>pyright</code>:</p><span class="code-source hidden" data-source=.dagger/src/monorepo_dagger/main.py></span><pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python">    <span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">function</span></span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-function z-python">    <span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">pyright</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">source_dir</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">SourceDir</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span> <span class="z-variable z-parameter z-python">project</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">"""</span>Run pyright for a given project.<span class="z-punctuation z-definition z-comment z-end z-python">"""</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">build_project</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">source_dir</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">project</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">container</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">with_exec</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pyright<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">stdout</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>Now we can just call these Dagger functions locally or in our CI/CD system ‚Äî they will work exactly the same! <a href=https://dagger.io/cloud>Dagger Cloud</a> can also be used to execute builds remotely (and the entire team can benefit from the shared cache). It‚Äôs also worth mentioning their <a href=https://depot.dev/blog/dagger-functions-for-depot>integration with Depot</a> ‚Äî provider for accelerated builds and caching, which requires zero configuration and can speed up builds even more.<h1 id=conclusion><a aria-label="Anchor link for: conclusion" class="header-anchor no-hover-padding" href=#conclusion><span aria-hidden=true class=link-icon></span></a> Conclusion</h1><p>Setting up and maintaining a Python monorepo can be a daunting task, but with the right tools and practices, it becomes manageable and even enjoyable. When combined together, <code>uv</code> and <code>Dagger</code> provide powerful features that dramatically simplify build processes while maintaining flexibility and providing enormous performance gains.<p>The pipeline we built is a good starting point for further customization and optimization. You can add more steps to the pipeline, such as linting, code formatting, and deployment steps, and add configuration options to create a comprehensive build process that meets your specific requirements. It‚Äôs very easy because it‚Äôs just Python code.<p>I encourage you to explore the documentation for these tools to fully understand their capabilities and how they can be tailored to your specific needs.<hr><p>References:<ul><li><a href=https://github.com/danielgafni/website/tree/master/www/content/blog/cracking-python-monorepo/uv-dagger-dream>source code</a> for this blog post<li><a href=https://docs.astral.sh/uv/getting-started/>uv Documentation</a><li><a href=https://docs.dagger.io/quickstart/cli>Dagger Documentation</a></ul></section><nav class="full-width article-navigation"><div></div><div><a aria-describedby=right_title aria-label=Prev href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cloud-computing-eks-part-2/>Prev¬†<span class=arrow>‚Üí</span></a><p aria-hidden=true id=right_title>Cloud Computing with EKS: Dagster with ArgoCD</div></nav><div class=comments data-category=Announcements data-category-id=DIC_kwDOLfTdus4CePI8 data-dark-theme=noborder_dark data-input-position=top data-lang=en data-lazy-loading=true data-light-theme=noborder_light data-mapping=specific data-reactions-enabled=1 data-repo=danielgafni/website data-repo-id=R_kgDOLfTdug data-strict=1 data-term=cracking-python-monorepo id=comments><script async src=https://danielgafni.github.io/website/pr-preview/pr-23/js/giscus.min.js></script><noscript>You need JavaScript to view the comments.</noscript></div></article></main><div id=button-container><div id=toc-floating-container><input class=toggle id=toc-toggle type=checkbox><label class=overlay for=toc-toggle></label><label title="Toggle Table of Contents" class=button for=toc-toggle id=toc-button><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg></label><div class=toc-content><div class=toc-container><ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#many-snake-in-package-scream>Many üêç in üì¶ ? üò±</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#a-brief-history-of-python-packaging>A brief history of Python packaging</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#setting-up-the-monorepo>Setting up the monorepo</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#cache-me-if-you-can>Cache me if you can</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#a-thousand-daggers>A thousand daggers</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#building-the-build-pipeline>Building the build pipeline</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#growing-the-pipeline>Growing the pipeline</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-23/blog/cracking-python-monorepo/#conclusion>Conclusion</a></ul></div></div></div><a title="Go to the comments section" class=no-hover-padding href=#comments id=comments-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule=evenodd fill-rule=evenodd /></svg> </a><a title="Go to the top of the page" class=no-hover-padding href=# id=top-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://danielgafni.github.io/website/pr-preview/pr-23/js/copyCodeToClipboard.min.js></script><script defer src=https://danielgafni.github.io/website/pr-preview/pr-23/js/codeBlockNameLinks.min.js></script><script defer src=https://danielgafni.github.io/website/pr-preview/pr-23/js/footnoteBacklinks.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://danielgafni.github.io/website/pr-preview/pr-23/atom.xml> <img alt=feed loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-23/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email=ZGFuaWVsZ2FmbmkxNkBnbWFpbC5jb20K href=#><img alt=email loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-23/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/danielgafni> <img alt=github loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-23/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://gitlab.com/danielgafni> <img alt=gitlab loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-23/social_icons/gitlab.svg title=gitlab> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://www.linkedin.com/in/danielgafni/> <img alt=linkedin loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-23/social_icons/linkedin.svg title=linkedin> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> <p><p>UNLICENSED 2025 Daniel Gafni ‚Ä¢ The contents of this website are free to use</p> Powered by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> ‚Ä¢ <a href=https://github.com/danielgafni/website> Site source </a></small></div></section><script async src=https://danielgafni.github.io/website/pr-preview/pr-23/js/decodeMail.min.js></script><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search‚Ä¶ role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>