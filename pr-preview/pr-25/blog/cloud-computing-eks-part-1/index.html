<!doctype html><html data-theme=dark lang=en><head><meta charset=UTF-8><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com giscus.app;connect-src 'self';script-src 'self'  giscus.app 'self'" http-equiv=Content-Security-Policy><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://danielgafni.github.io/website/pr-preview/pr-25 name=base><title>~/danielgafni • Cloud Computing with EKS: Cluster Setup</title><link href=https://danielgafni.github.io/website/pr-preview/pr-25/favicon.png rel=icon type=image/png><link title="~/danielgafni - Atom Feed" href=https://danielgafni.github.io/website/pr-preview/pr-25/atom.xml rel=alternate type=application/atom+xml><link href="https://danielgafni.github.io/website/pr-preview/pr-25/custom_subset.css?h=0b9535a28bc3d5bf2321" rel=stylesheet><link href="https://danielgafni.github.io/website/pr-preview/pr-25/main.css?h=fa464346b37e382872db" rel=stylesheet><link href="https://danielgafni.github.io/website/pr-preview/pr-25/skins/catppuccin.css?h=ddda112c1cfca66427b5" rel=stylesheet><meta content="light dark" name=color-scheme><meta media="(prefers-color-scheme: light)" content=#7287fd name=theme-color><meta media="(prefers-color-scheme: dark)" content=#81c8be name=theme-color><meta name=description><meta property=og:description><meta content="Cloud Computing with EKS: Cluster Setup" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale><meta content=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/ property=og:url><meta content=~/danielgafni property=og:site_name><noscript><link href=https://danielgafni.github.io/website/pr-preview/pr-25/no_js.css rel=stylesheet></noscript><script src=https://danielgafni.github.io/website/pr-preview/pr-25/js/initializeTheme.min.js></script><script defer src=https://danielgafni.github.io/website/pr-preview/pr-25/js/themeSwitcher.min.js></script><script src="https://danielgafni.github.io/website/pr-preview/pr-25/search_index.en.js?h=ad2efae32c09d7abafec" defer></script><script src="https://danielgafni.github.io/website/pr-preview/pr-25/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://danielgafni.github.io/website/pr-preview/pr-25>~/danielgafni</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/>/blog </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-25/archive/>/archive </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-25/tags/>/tags </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-25/projects/>/projects </a><li><a class="nav-links no-hover-padding" href=https://danielgafni.github.io/website/pr-preview/pr-25/about/>/about </a><li class=menu-icons-container><ul class=menu-icons-group><li class="js menu-icon"><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></ul></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Cloud Computing with EKS: Cluster Setup</h1><ul class=meta><li>25th May 2024<li title="1964 words"><span aria-hidden=true class=separator>•</span>10 min read<li class=tag><span aria-hidden=true class=separator>•</span>Tags: <li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-25/tags/aws/>AWS</a>, <li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-25/tags/eks/>EKS</a>, <li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-25/tags/kubernetes/>Kubernetes</a>, <li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-25/tags/devops/>DevOPS</a>, <li class=tag><a href=https://danielgafni.github.io/website/pr-preview/pr-25/tags/terraform/>Terraform</a></ul><div class=toc-container><h3>Table of Contents</h3><ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#introduction>Introduction</a> <ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#prerequisites>Prerequisites</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#goals-tools>Goals & Tools</a></ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#who-scales-the-autoscaler>Who scales the autoscaler?</a> <ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#creating-nodepools-with-karpenter>Creating NodePools with Karpenter</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#gpu-nodes>GPU nodes</a></ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#dns-caching>DNS caching</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#cloud-district>Cloud District</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#wrapping-it-up>Wrapping it up</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#footnotes>Footnotes</a></ul></div><section class=body><p>This series of posts is an opinionated tutorial for setting up production-grade Kubernetes clusters & deployments on AWS <sup class=footnote-reference><a href=#1>1</a></sup>. It aims to be as detailed and correct as possible and will provide complete pieces of relevant <a href=https://github.com/danielgafni/website/tree/master/www/content/blog/cloud-computing-eks-part-1/src>source code</a>.<p>This tutorial is split into 2 parts. The first part is devoted to creating EKS & supporting infra, and the second part describes Dagster installation.<h1 id=introduction><a aria-label="Anchor link for: introduction" class="header-anchor no-hover-padding" href=#introduction><span aria-hidden=true class=link-icon></span></a> Introduction</h1><p>In the Data & ML space, we often encounter workloads with high computational requirements. Kubernetes with its near to infinite customization options and scalability is a natural choice for running such workloads.<p>Kubernetes is a platform for running applications in the cloud. We can use it to dynamically provide compute and to configure our deployments.<p>We also need a tool to orchestrate the actual jobs running on the compute resources provided by Kubernetes. <a href=https://dagster.io/>Dagster</a> is an excellent Jobs & Data Orchestrator with a unique declarative, asset-based programming model. It’s an ideal choice for batch processing workloads. Dagster can be deployed on Kubernetes, which enables it to orchestrate data processing at massive scale.<h2 id=prerequisites><a aria-label="Anchor link for: prerequisites" class="header-anchor no-hover-padding" href=#prerequisites><span aria-hidden=true class=link-icon></span></a> Prerequisites</h2><ul><li>AWS access with sufficient permissions<li>A domain (referred to as <code>&LTdomain></code> in the article) managed by AWS Route 53</ul><h2 id=goals-tools><a aria-label="Anchor link for: goals-tools" class="header-anchor no-hover-padding" href=#goals-tools><span aria-hidden=true class=link-icon></span></a> Goals & Tools</h2><p>On a high level, these are the technical requiremnets for our data processing system:<ul><li>Have an auto-scaling Dagster deployment running on Kubernetes. Auto-scaling is important because we don’t want to be paying for idle nodes, and we want to spin up a lot of them when processing large amounts of data.<li>Leverage cheap Spot instances for up to 90% costs reduction. Spot instances are much cheaper than on-demand instances, but are not reliable and can be shut down at any moment. Workloads using Spot instances should be fault-tolerant, which is usually achieved by techniques such as checkpointing and retries.<li>We need secure external access to this deployment. Because OSS Dagster doesn’t have built-in authentication, we will provide a Basic Auth wrapper for its Webserver. This simple authentication layer can be later replaced by something more flexible (like OAUTH).<li>Have automatic Dagster Branch deployments for Pull Requests. Branch Deployments are incredibly useful for development and speedup software iteration cycles by an order of magnitude.</ul><p>We will be using various free & Open Source tools in order to satisfy the above requirements <sup class=footnote-reference><a href=#2>2</a></sup>:<ul><li><a href=https://opentofu.org/>OpenTofu</a> (open Terraform fork) to create the EKS cluster and other supporting infrastructure<li><a href=https://karpenter.sh/>Karpenter</a> for auto-scaling EC2 (spot) instances<li><a href=https://cert-manager.io/>Cert Manager</a> for getting free SSL certificates from Let’s Encrypt<li><a href=https://traefik.io/traefik/>Traefik</a> as a reverse proxy, ingress controller & simple Basic Auth middleware for Dagster’s Webserver<li>NodeLocal DNSCache for reducing load on AWS DNS servers (it’s actually quite easy to overload them!)<li><a href=https://argo-cd.readthedocs.io/en/stable/>ArgoCD</a> to deploy Dagster and automatically create Branch Deployments for Pull Requests</ul><h1 id=who-scales-the-autoscaler><a aria-label="Anchor link for: who-scales-the-autoscaler" class="header-anchor no-hover-padding" href=#who-scales-the-autoscaler><span aria-hidden=true class=link-icon></span></a> Who scales the autoscaler?</h1><p>For all things AWS, we will be using the amazing <a href=https://registry.terraform.io/namespaces/terraform-aws-modules>terraform-aws-modules</a> Terraform modules. They provide pre-configured AWS resources for common use-cases.<p>Let’s start by creating the EKS cluster:<details><summary>Click to reveal code</summary> <span class="code-source hidden" data-source=terraform/eks/main.tf></span> <pre class="language-terraform z-code" data-lang=terraform><code class=language-terraform data-lang=terraform><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">data</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>aws_region<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>current<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">locals</span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_name</span>      <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_subdomain</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>k8s-</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">data</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">aws_region</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">current</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-quoted z-double z-terraform">-</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">tags</span>              <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">tags</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">module</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>eks<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">source</span>  <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>terraform-aws-modules/eks/aws<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">version</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>~> 20.0<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_name</span>    <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_version</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>1.29<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">vpc_id</span>     <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">vpc_id</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">subnet_ids</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">subnet_ids</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> map with IAM users/roles and Kubernetes access permissions<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">access_entries</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">access_entries</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">create_iam_role</span>                 <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_endpoint_public_access</span>  <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_endpoint_private_access</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_addons</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">coredns</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">most_recent</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">true</span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> TODO: pin exact version<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">kube-proxy</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">most_recent</span></span>    <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">true</span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> TODO: pin exact version<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">before_compute</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">true</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">vpc-cni</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">most_recent</span></span>    <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">true</span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> TODO: pin exact version<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">before_compute</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">true</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">aws-ebs-csi-driver</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">most_recent</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">true</span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> TODO: pin exact version<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">amazon-cloudwatch-observability</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> TODO: pin exact version<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">most_recent</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">true</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">  <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">eks_managed_node_groups</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">default</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">instance_types</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>t3.medium<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span><span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">min_size</span></span>       <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-numeric z-integer z-terraform">2</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">max_size</span></span>       <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-numeric z-integer z-terraform">10</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">desired_size</span></span>   <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-numeric z-integer z-terraform">2</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">  <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> https://stackoverflow.com/questions/74687452/eks-error-syncing-load-balancer-failed-to-ensure-load-balancer-multiple-tagge<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">node_security_group_tags</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubernetes.io/cluster/${local.cluster_name}<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-constant z-language z-terraform">null</span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">  <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">tags</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-meta z-function-call z-terraform"><span class="z-support z-function z-builtin z-terraform">merge</span><span class="z-punctuation z-section z-parens z-begin z-terraform">(</span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-function-call z-terraform">    <span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">tags</span><span class="z-punctuation z-separator z-terraform">,</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-function-call z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter.sh/discovery<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-function-call z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-function-call z-terraform">  <span class="z-punctuation z-section z-parens z-end z-terraform">)</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span></code></pre></details><p>The terraform code creates a local variable <code>local.cluster_subdomain</code>. We compose it as following: <code>k8s-&LTregion>-&LTcluster-name></code>. This is a human-readable sensible default as cluster names are unique per region. We will be assigning <code>k8s-&LTregion>-&LTcluster-name>.&LTdomain></code> to Traefik’s LoadBalancer later on.<p>Notice how the cluster only has a single Node Group. This is because we are going to be using Karpenter for node provisioning.<h2 id=creating-nodepools-with-karpenter><a aria-label="Anchor link for: creating-nodepools-with-karpenter" class="header-anchor no-hover-padding" href=#creating-nodepools-with-karpenter><span aria-hidden=true class=link-icon></span></a> Creating NodePools with Karpenter</h2><p><a href=https://karpenter.sh/>Karpenter</a> is a feature-rich and easy to use Kubernetes autoscaler. It allows defining <code>NodePool</code>s and other objects as Kubernetes Custom Resources via simple YAML. This is beneficial for multiple reasons, and allows doing really interesting (and questionable) stuff like configuring NodePools from application <code>helm</code> values.<p>While being really great, Karpenter pods can’t magically appear in our cluster out of nowhere, so sadly they need an initial NodeGroup to run on. Afterwards, Karpenter will launch additional EC2 instances to join the cluster to satisfy Pod scheduling needs.<p>Currently, Karpenter only works with AWS EKS, but the project is aiming to support other cloud providers in the future.<p>Karpenter is aware of Kubernetes <a href=https://kubernetes.io/docs/reference/labels-annotations-taints/>well-known</a> labels (such as OS, CPU architecture, …) and aws-specific labels (such as <code>instance-type</code>, <code>instance-size</code>, …) is aware of instance pricing, can drain Kubernetes nodes running on spot instances ahead of node termination, and much more. This enables configuring really flexible auto-scaling <code>NodePool</code>s.<p>Let’s install Karpenter to our cluster and add a default <code>NodePool</code>. We will be using the community <a href=https://github.com/alekc/terraform-provider-kubectl>kubectl</a> Terraform provider to create Karpenter’s Custom Resources (CRs), since the other official provider - <a href=https://github.com/hashicorp/terraform-provider-kubernetes>kubernetes</a> - <a href=https://github.com/hashicorp/terraform-provider-kubernetes/issues/1367>does not properly support CRs</a>, so we are left with whatever actually works.<details><summary>Click to reveal code</summary> <span class="code-source hidden" data-source=terraform/eks/karpenter.tf></span> <pre class="language-terraform z-code" data-lang=terraform><code class=language-terraform data-lang=terraform><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> this module creates supporting infrastructure for Karpenter<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> like IAM and spot instances info SQS queue<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> but doesn't deploy Karpenter itself<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">module</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">source</span>  <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>terraform-aws-modules/eks/aws//modules/karpenter<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">version</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>~> 20.8.5<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">cluster_name</span>           <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">irsa_oidc_provider_arn</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">oidc_provider_arn</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> Used to attach additional IAM policies to the Karpenter node IAM role<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">enable_irsa</span>         <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> TODO: uncomment this<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">enable_pod_identity</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">node_iam_role_additional_policies</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">AmazonSSMManagedInstanceCore</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">  <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">tags</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">tags</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> here we actually install Karpenter with helm<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>helm_release<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">namespace</span>        <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">create_namespace</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>             <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">repository</span>       <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>oci://public.ecr.aws/karpenter<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">chart</span>            <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">version</span>          <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>0.36.0<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">wait</span>             <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">values</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">    <span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">EOT</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    settings:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      clusterName: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      clusterEndpoint: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_endpoint</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      interruptionQueue: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">karpenter</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">queue_name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    serviceAccount:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      annotations:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        eks.amazonaws.com/role-arn: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">karpenter</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">iam_role_arn</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    EOT
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> add a default NodeClass<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter-node-class-default<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: karpenter.k8s.aws/v1beta1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: EC2NodeClass
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: default
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      namespace: karpenter
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      amiFamily: AL2
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      role: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">karpenter</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">node_iam_role_name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      subnetSelectorTerms:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - tags:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            karpenter.sh/discovery: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      securityGroupSelectorTerms:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - tags:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            karpenter.sh/discovery: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      tags:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        karpenter.sh/discovery: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">  YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">depends_on</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">    helm_release<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">karpenter</span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> need to add this explicit dependency<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> add a default NodePool<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter-node-pool-default<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: karpenter.sh/v1beta1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: NodePool
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: default
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      namespace: karpenter
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      template:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          nodeClassRef:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            name: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">karpenter-node-class-default</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          requirements:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - key: kubernetes.io/arch
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              operator: In
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              values: ["amd64"]
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - key: kubernetes.io/os
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              operator: In
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              values: ["linux"]
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - key: karpenter.sh/capacity-type
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              operator: In
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              values: ["on-demand"]
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - key: karpenter.k8s.aws/instance-category
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              operator: In
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              values: ["c", "m", "r", "t"]
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      limits:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        cpu: 100
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      disruption:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        consolidationPolicy: WhenUnderutilized
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      expireAfter: 720h
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">  YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>karpenter-node-class-deeplearning<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: karpenter.k8s.aws/v1beta1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: EC2NodeClass
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span></code></pre></details><p>This is how we can add a <code>NodePool</code> for spot instances:<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml">    <span class="z-constant z-numeric z-float z-decimal z-yaml"><span class="z-punctuation z-separator z-decimal z-yaml">.</span>..</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">spec</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">template</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">spec</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">requirements</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">            <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">karpenter.sh/capacity-type</span>
</span><span class="z-source z-yaml">              <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">operator</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">In</span>
</span><mark><span class="z-source z-yaml">              <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">values</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>spot<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
</span></mark><span class="z-source z-yaml">    <span class="z-constant z-numeric z-float z-decimal z-yaml"><span class="z-punctuation z-separator z-decimal z-yaml">.</span>..</span>
</span></code></pre><p>if the requirement <code>karpenter.sh/capacity-type</code> is set to math both <code>"on-demand"</code> and <code>"spot"</code>, then Karpenter will prefer spot instances and automatically fallback to on-demand during shortages.<h2 id=gpu-nodes><a aria-label="Anchor link for: gpu-nodes" class="header-anchor no-hover-padding" href=#gpu-nodes><span aria-hidden=true class=link-icon></span></a> GPU nodes</h2><p>If you are doing machine learning, chances are you will need GPUs in your cluster!<p>Here is how we can setup a GPU-compatible <code>EC2NodeClass</code> with Karpenter:<details><summary>Click to reveal code</summary> <span class="code-source hidden" data-source=terraform/eks/karpenter.tf></span> <pre class="language-terraform z-code" data-lang=terraform><code class=language-terraform data-lang=terraform><span class="z-source z-terraform">      name<span class="z-keyword z-operator z-terraform">:</span> deeplearning
</span><span class="z-source z-terraform">      namespace<span class="z-keyword z-operator z-terraform">:</span> karpenter
</span><span class="z-source z-terraform">    spec<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">      amiFamily<span class="z-keyword z-operator z-terraform">:</span> AL2
</span><span class="z-source z-terraform">      amiSelectorTerms<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">        <span class="z-keyword z-operator z-arithmetic z-terraform">-</span> name<span class="z-keyword z-operator z-terraform">:</span> amazon<span class="z-keyword z-operator z-arithmetic z-terraform">-</span>eks<span class="z-keyword z-operator z-arithmetic z-terraform">-</span>gpu<span class="z-keyword z-operator z-arithmetic z-terraform">-</span>node<span class="z-keyword z-operator z-arithmetic z-terraform">-</span>$<span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>module.eks.cluster_version<span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span><span class="z-keyword z-operator z-arithmetic z-terraform">-</span>v20240703  <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> optimized gpu ami<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform">      role<span class="z-keyword z-operator z-terraform">:</span> $<span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>module.karpenter.node_iam_role_name<span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">      <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> increase static storage size to handle large DL images<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform">      blockDeviceMappings<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">      <span class="z-keyword z-operator z-arithmetic z-terraform">-</span> deviceName<span class="z-keyword z-operator z-terraform">:</span> <span class="z-keyword z-operator z-arithmetic z-terraform">/</span>dev<span class="z-keyword z-operator z-arithmetic z-terraform">/</span>xvda
</span><span class="z-source z-terraform">        ebs<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">          volumeSize<span class="z-keyword z-operator z-terraform">:</span> $<span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>var.volume_size_gb<span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span> <span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> set to something like 100Gi<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform">          volumeType<span class="z-keyword z-operator z-terraform">:</span> gp3
</span><span class="z-source z-terraform">          iops<span class="z-keyword z-operator z-terraform">:</span> <span class="z-constant z-numeric z-integer z-terraform">10000</span>
</span><span class="z-source z-terraform">          deleteOnTermination<span class="z-keyword z-operator z-terraform">:</span> <span class="z-constant z-language z-terraform">true</span>
</span><span class="z-source z-terraform">          throughput<span class="z-keyword z-operator z-terraform">:</span> <span class="z-constant z-numeric z-integer z-terraform">125</span>
</span><span class="z-source z-terraform">      subnetSelectorTerms<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">        <span class="z-keyword z-operator z-arithmetic z-terraform">-</span> tags<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">            karpenter<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">sh</span><span class="z-keyword z-operator z-arithmetic z-terraform">/</span>discovery<span class="z-keyword z-operator z-terraform">:</span> $<span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>module.eks.cluster_name<span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">      securityGroupSelectorTerms<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">        <span class="z-keyword z-operator z-arithmetic z-terraform">-</span> tags<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">            karpenter<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">sh</span><span class="z-keyword z-operator z-arithmetic z-terraform">/</span>discovery<span class="z-keyword z-operator z-terraform">:</span> $<span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>module.eks.cluster_name<span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">      tags<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">        karpenter<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">sh</span><span class="z-keyword z-operator z-arithmetic z-terraform">/</span>discovery<span class="z-keyword z-operator z-terraform">:</span> $<span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>module.eks.cluster_name<span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>}
</span><span class="z-source z-terraform">      disruption<span class="z-keyword z-operator z-terraform">:</span>
</span><span class="z-source z-terraform">        consolidationPolicy<span class="z-keyword z-operator z-terraform">:</span> WhenUnderutilized
</span><span class="z-source z-terraform">      expireAfter<span class="z-keyword z-operator z-terraform">:</span> 720h
</span><span class="z-source z-terraform">  YAML
</span><span class="z-source z-terraform">}
</span></code></pre></details><p>You can explore EKS AMI <a href=https://github.com/awslabs/amazon-eks-ami/releases>releases</a> for more images.<p>Now, let’s reference this <code>EC2NodeClass</code> to create a <code>NodePool</code>:<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml">    <span class="z-constant z-numeric z-float z-decimal z-yaml"><span class="z-punctuation z-separator z-decimal z-yaml">.</span>..</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">spec</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">nodeClassRef</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><mark><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">${kubectl_manifest.karpenter-node-class-deeplearning.name}</span>
</span></mark><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">requirements</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">kubernetes.io/arch</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">operator</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">In</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">values</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>amd64<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
</span><span class="z-source z-yaml">        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">kubernetes.io/os</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">operator</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">In</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">values</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>linux<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
</span><span class="z-source z-yaml">        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">karpenter.k8s.aws/instance-gpu-count</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">operator</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">Gt</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">values</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>0<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
</span><span class="z-source z-yaml">        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">key</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">karpenter.k8s.aws/instance-gpu-manufacturer</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">operator</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">In</span>
</span><span class="z-source z-yaml">          <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">values</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>nvidia<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
</span><span class="z-source z-yaml">    <span class="z-constant z-numeric z-float z-decimal z-yaml"><span class="z-punctuation z-separator z-decimal z-yaml">.</span>..</span>
</span></code></pre><p>The <code>requirements</code> field here is really versatile and can be changed according to specific needs.<h1 id=dns-caching><a aria-label="Anchor link for: dns-caching" class="header-anchor no-hover-padding" href=#dns-caching><span aria-hidden=true class=link-icon></span></a> DNS caching</h1><p>The last component to complete the hyper scaling setup is NodeLocal DNS Cache. It’s really important to set it up, otherwise launching more than ~500 pods will result in frequent <code>Temporary Name Resolution Failure</code> when accessing AWS services such as <code>S3</code> or <code>RDS</code>.</p><span class="code-source hidden" data-source=terraform/eks/node-local-dns.tf></span><pre class="language-terraform z-code" data-lang=terraform><code class=language-terraform data-lang=terraform><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>helm_release<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>node-local-dns<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">namespace</span>  <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kube-system<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>       <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>node-local-dns<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">repository</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>https://charts.deliveryhero.io<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">chart</span>      <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>node-local-dns<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">version</span>    <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>2.0.9<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">wait</span>       <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span></code></pre><p>I haven’t included supporting Terraforms files (<code>providers.tf</code>, <code>variables.tf</code> and <code>outputs.tf</code>) above since they are self-explanatory.<p>Now, let’s get to the ingress LoadBalancer setup.<h1 id=cloud-district><a aria-label="Anchor link for: cloud-district" class="header-anchor no-hover-padding" href=#cloud-district><span aria-hidden=true class=link-icon></span></a> Cloud District</h1><p>We are aiming to expose (securely) our Kubernetes services to the outside world, and we are not running away from Load Balancers, various middlewares, autentication, route management, SSL certificates, and so on. Setting all of this in automated fasion for Branch Deployments might get really complicated.<p>Traefik and Cert Manager are the two mainstream free and open source Kubernetes applications often used to solve this kind of problems. I will give a brief explanation below, but the reader is welcome to dive into their documentation.<p><a href=https://traefik.io/traefik/>Traefik</a> is a reverse proxy which can be deployed with it’s own Load Balancer. It can then route traffic from this Load Balancer to other Kubernetes services. It can be used to inject various useful middlewares which can do stuff like <code>https -> http</code> redirect, rate limiting, basic auth, modify request paths, etc. The full list can be found <a href=https://doc.traefik.io/traefik/middlewares/http/overview/>here</a>. It also allows to automatically provision SSL certificates and supports free services such as <a href=https://letsencrypt.org/>Lets Encrypt</a>. It allows doing all of this via Kubernetes CRs. Load Balancers can get quite expensive, and Traefik allows easily using a single Load Balancer for all your services. It also has a great dashboard!<p>While Traefik can generate SSL certificates out of the box, we will be using a separate solution for that - <a href=https://cert-manager.io/>Cert Manager</a>. This way we are not too reliant on Traefik, and Cert Manager is actually more versatile (since issuing certificates is it’s primary job).<p>Both Traefik and Cert Manager can be deployed without Terraform, but using Terraform allows automating the registration of the <code>CNAME</code> record for Traefik’s Load Balancer, which is a crusial step when provisioning new EKS clusters.<p>Seems like a match made in <del>the cloud</del> heaven!<p>Let’s start by installing Traefik.<details><summary>Click to reveal code</summary> <span class="code-source hidden" data-source=terraform/eks/traefik.tf></span> <pre class="language-terraform z-code" data-lang=terraform><code class=language-terraform data-lang=terraform><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>helm_release<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">namespace</span>        <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">create_namespace</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>             <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">repository</span>       <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>https://traefik.github.io/charts<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">chart</span>            <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">version</span>          <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>27.0.2<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">wait</span>             <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">depends_on</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">values</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    ingressClass:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      enabled: true
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      isDefaultClass: true
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      fallbackApiVersion: v1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    ingressRoute:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      dashboard:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        enabled: false
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    service:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: traefik
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      annotations:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        # create an external AWS LoadBalancer for this service
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        service.beta.kubernetes.io/aws-load-balancer-type: nlb
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    globalArguments:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      - "--api.insecure=true"
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">data</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubernetes_service<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-meta z-type z-terraform"><span class="z-entity z-name z-type z-terraform">metadata</span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-block z-terraform">    <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>      <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-block z-terraform">    <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">namespace</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">depends_on</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span>helm_release<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">traefik</span><span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> route subdomain.domain to the AWS LoadBalancer (just in case)<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>aws_route53_record<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">zone_id</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">zone_id</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>    <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">type</span>    <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>CNAME<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">ttl</span>     <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>300<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">records</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-support z-constant z-terraform">data</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">kubernetes_service</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">traefik</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">status</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-constant z-numeric z-integer z-terraform">0</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">load_balancer</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-constant z-numeric z-integer z-terraform">0</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">ingress</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-constant z-numeric z-integer z-terraform">0</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">hostname</span><span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> route all web requests such as x.subdomain.domain to the AWS LoadBalanacer<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>aws_route53_record<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik-wildcard<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">zone_id</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">zone_id</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>    <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>*.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">type</span>    <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>CNAME<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">ttl</span>     <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>300<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">records</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-support z-constant z-terraform">data</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">kubernetes_service</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">traefik</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">status</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-constant z-numeric z-integer z-terraform">0</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">load_balancer</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-constant z-numeric z-integer z-terraform">0</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">ingress</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-constant z-numeric z-integer z-terraform">0</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">hostname</span><span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span></code></pre></details><p>We installed the <code>Traefik</code> helm chart into <code>traefik</code> namespace. We annotated the Service with <code>service.beta.kubernetes.io/aws-load-balancer-type: nlb</code> to create an AWS external LoadBalancer, and created CNAME DNS records in AWS Route 53 to route web requests to our domain to this LoadBalancer.<p>Notice how the chart has the default dashboard’s <code>IngressRoute</code> disabled. Instead, we are going to create a custom one. We are going to need an SSL certificate to secure the dashboard with HTTPS. Let’s install Cert Manager to issue this certificate:<details><summary>Click to reveal code</summary> <span class="code-source hidden" data-source=terraform/eks/cert-manager.tf></span> <pre class="language-terraform z-code" data-lang=terraform><code class=language-terraform data-lang=terraform><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> this will create a role wich will be automatically assumed by <span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> pods running in cert-manager namespace under cert-manager Kubernetes Service Account<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">module</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>eks-irsa-cert-manager<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">source</span>    <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>terraform-aws-modules/iam/aws//modules/iam-role-for-service-accounts-eks<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">role_name</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>cert-manager-</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">attach_cert_manager_policy</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">oidc_providers</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">eks</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">provider_arn</span></span>               <span class="z-keyword z-operator z-terraform">=</span> <span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">oidc_provider_arn</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">      <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">namespace_service_accounts</span></span> <span class="z-keyword z-operator z-terraform">=</span> <span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>cert-manager:cert-manager<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span><span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-braces z-terraform">  <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>helm_release<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>cert-manager<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">namespace</span>        <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>cert-manager<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">create_namespace</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>             <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>cert-manager<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">repository</span>       <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>https://charts.jetstack.io<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">chart</span>            <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>cert-manager<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">version</span>          <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>1.14.5<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">wait</span>             <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-language z-terraform">true</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">values</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    installCRDs: true
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    serviceAccount:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: cert-manager  # make sure to pin the Service Account name for IRSA to work
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      annotations:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        # specify the role to assume
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        eks.amazonaws.com/role-arn: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks-irsa-cert-manager</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">iam_role_arn</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    # important for route53
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    securityContext:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      fsGroup: 1001
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    extraArgs:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    - --enable-certificate-owner-ref=true
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    - --dns01-recursive-nameservers-only
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    - --dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    podDnsPolicy: "None"
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    podDnsConfig:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      nameservers:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - "1.1.1.1"
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - "8.8.8.8"
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">depends_on</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span><span class="z-support z-constant z-terraform">module</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">eks</span><span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> create a ClusterIssuer for DNS-01 challange<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>clusterIssuer-letsencrypt-prod-dns01<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: cert-manager.io/v1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: ClusterIssuer
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        name: letsencrypt-prod-dns01
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        namespace: cert-manager
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        acme:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          email: "</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">acme_email</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">"
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          server: "https://acme-v02.api.letsencrypt.org/directory"
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          privateKeySecretRef:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            name: "letsencrypt-prod-dns01"  # Secret resource that will be used to store the account's private key.
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          solvers:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - dns01:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">                route53:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">                  region: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">route_53_region</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">                  hostedZoneID: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">hosted_zone_id</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              selector:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">                dnsZones:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">                  - '</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">domain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">'
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">depends_on</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">    helm_release<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cert-manager</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span></code></pre></details><p>We installed the <code>cert-manager</code> Helm chart into <code>cert-manage</code> namespace and created a <code>ClusterIssuer</code> for the <code>DNS-01</code> challange. This challenge requires creating a given TXT record for the claimed domain, so <code>cert-manager</code>’s pod will need access to certain Route 53 policies in order to create this record on Let’s Enctrypt’s demand. This is covered by creating an IAM role for <code>cert-manager</code> and providing the role’s name as Kubernetes Service Account annotation.<p>Now, we can continue with Traefik Dashboard setup:<details><summary>Click to reveal code</summary> <span class="code-source hidden" data-source=terraform/eks/traefik-dashboard.tf></span> <pre class="language-terraform z-code" data-lang=terraform><code class=language-terraform data-lang=terraform><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> SSL certificate for Traefik's Dashboard UI<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>certificate-traefik-dashboard<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: cert-manager.io/v1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: Certificate
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: traefik-dashboard-</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">clusterIssuer-letsencrypt-prod-dns01</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      namespace: traefik
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      secretName: traefik-dashboard-tls-</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">clusterIssuer-letsencrypt-prod-dns01</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      dnsNames:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - "traefik.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">domain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">"
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      issuerRef:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        kind: ClusterIssuer
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        name: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">clusterIssuer-letsencrypt-prod-dns01</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> password for the dashboard's Basic Auth<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>random_password<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik-dashboard<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">length</span>           <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-constant z-numeric z-integer z-terraform">16</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">override_special</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span><+)<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>aws_secretsmanager_secret<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik-dashboard<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">name</span>        <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik-dashboard-</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">description</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>Traefik Dashboard credentials for https://traefik.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-quoted z-double z-terraform">.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">domain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-quoted z-double z-terraform">/dashboard/<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">tags</span>        <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">tags</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> store the password as ASM secret<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>aws_secretsmanager_secret_version<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>traefik-dashboard<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">secret_id</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span>aws_secretsmanager_secret<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">traefik-dashboard</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">id</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">secret_string</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-meta z-function-call z-terraform"><span class="z-support z-function z-builtin z-terraform">jsonencode</span><span class="z-punctuation z-section z-parens z-begin z-terraform">(</span><span class="z-meta z-braces z-terraform"><span class="z-punctuation z-section z-braces z-begin z-terraform">{</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-function-call z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">user</span></span>     <span class="z-keyword z-operator z-terraform">=</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>admin<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span><span class="z-punctuation z-separator z-terraform">,</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-function-call z-terraform"><span class="z-meta z-braces z-terraform">    <span class="z-meta z-mapping z-key z-terraform"><span class="z-string z-unquoted z-terraform">password</span></span> <span class="z-keyword z-operator z-terraform">=</span> random_password<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">traefik-dashboard</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">result</span>
</span></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-meta z-function-call z-terraform"><span class="z-meta z-braces z-terraform">  <span class="z-punctuation z-section z-braces z-end z-terraform">}</span></span><span class="z-punctuation z-section z-parens z-end z-terraform">)</span></span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> store the dashboard password inside Kubernetes<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>secret-traefik-dashboard-basic-auth-creds<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: v1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: Secret
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: traefik-dashboard-basic-auth-creds
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      namespace: traefik
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    type: kubernetes.io/basic-auth
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    stringData:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      username: admin
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      password: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>random_password<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">traefik-dashboard</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">result</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">depends_on</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-punctuation z-section z-brackets z-begin z-terraform">[</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">    helm_release<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">traefik</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-punctuation z-section z-brackets z-end z-terraform">]</span>
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> create a middleware for dashboard's Basic Auth<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>middleware-traefik-dashboard-basic-auth<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: traefik.containo.us/v1alpha1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: Middleware
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: traefik-dashboard-auth
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      namespace: traefik
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      basicAuth:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        secret: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">secret-traefik-dashboard-basic-auth-creds</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> create a middleware to redirect HTTP requests to HTTPS<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>middleware-https-redirectscheme<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: traefik.containo.us/v1alpha1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: Middleware
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: https-redirectscheme
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      namespace: traefik
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      redirectScheme:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        permanent: true
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        scheme: https
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform">
</span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> create a route for Traefik<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> this route will send all requests starting by traefik.subdomain.domain/dashboard/ <span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> to the Traefik Dashboard Kubernetes service<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-comment z-line z-terraform"><span class="z-punctuation z-definition z-comment z-terraform">#</span> and insert the above middlewares into the route<span class="z-punctuation z-definition z-comment z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-type z-terraform"><span class="z-storage z-type z-terraform">resource</span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>kubectl_manifest<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-string z-quoted z-double z-terraform"><span class="z-punctuation z-definition z-string z-begin z-terraform">"</span>ingressRoute-traefik-dashboard<span class="z-punctuation z-definition z-string z-end z-terraform">"</span></span> <span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-begin z-terraform">{</span></span></span><span class="z-meta z-block z-terraform">
</span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform">  <span class="z-variable z-declaration z-terraform"><span class="z-variable z-other z-readwrite z-terraform">yaml_body</span> <span class="z-keyword z-operator z-assignment z-terraform">= </span></span><span class="z-keyword z-operator z-heredoc z-terraform"><&LT-</span><span class="z-keyword z-control z-heredoc z-terraform">YAML</span>
<span class="z-string z-unquoted z-heredoc z-terraform"></span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    apiVersion: traefik.containo.us/v1alpha1
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    kind: IngressRoute
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    metadata:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      name: traefik-dashboard
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      namespace: traefik
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">    spec:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      entryPoints:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - web
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - websecure
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      routes:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        - match: Host(`traefik.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">local</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">cluster_subdomain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">.</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span><span class="z-support z-constant z-terraform">var</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">domain</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">`) && (PathPrefix(`/dashboard`, `/dashboard/`) || PathPrefix(`/api`, `/api/`))
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          kind: Rule
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          services:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - name: api@internal
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">              kind: TraefikService
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">          middlewares:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - name: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">middleware-https-redirectscheme</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">            - name: </span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">middleware-traefik-dashboard-basic-auth</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">      tls:
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform">        secretName: traefik-dashboard-tls-</span><span class="z-meta z-interpolation z-terraform"><span class="z-keyword z-other z-interpolation z-begin z-terraform">${</span>kubectl_manifest<span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">clusterIssuer-letsencrypt-prod-dns01</span><span class="z-keyword z-operator z-accessor z-terraform">.</span><span class="z-variable z-other z-member z-terraform">name</span><span class="z-keyword z-other z-interpolation z-end z-terraform">}</span></span><span class="z-string z-unquoted z-heredoc z-terraform">
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-string z-unquoted z-heredoc z-terraform"></span><span class="z-keyword z-control z-heredoc z-terraform">    YAML
</span></span></span><span class="z-source z-terraform"><span class="z-meta z-block z-terraform"><span class="z-punctuation z-section z-block z-end z-terraform">}</span></span>
</span></code></pre></details><p>First, we create a <code>Certificate</code> - a CR provided by Cert Manager - claiming to own the domain <code>traefik.${local.cluster_subdomain}.${var.domain}</code>. Once the <code>Certificate</code> CR is created in Kubernetes, Cert Manager’s Controller pod will notice it and start the domain verification process agsinst Let’s Encrypt by using the <code>DNS-01</code> challenge. Let’s Encrypt will give Cert Manager a secret token and ask it to expose it via a TXT DNS record. Cert Manager will create this AWS Route 53 record, thus proving actual domain ownership to Let’s Encrypt, and the <code>Certificate</code> will be issued and stored in a corresponding Kubernetes <code>Secret</code>. Note that Cert Manager supports multiple <a href=https://cert-manager.io/docs/configuration/acme/dns01/#supported-dns01-providers>other</a> DNS providers other than Route 53.<p>We then reference this Secret in the <code>IngresRoute</code> - a CR provided by Traefik. We also create and reference a bunch of supporting resources, such as Basic Auth middleware, and store the password for it in AWS Secrets Manager.<p>Phew! After running <code>tofu apply</code>, a bit of patience (and possible tears if something goes wrong), we should be able to:<ul><li>inspect the created AWS Secrets Manager secret for Traefik Dashboard to retrive the Traefik Dashboard password<li>access the Traefik Dashboard at <code>https://traefik.k8s-&LTregion>-&LTcluster>.&LTdomain>/dashboard/</code> (the training slash is <strong>important</strong>)</ul><p>The dashboard allows inspecting the created routes for more details:<p><img alt="Traefik Dashboard" src=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/traefik-dashboard.png><h1 id=wrapping-it-up><a aria-label="Anchor link for: wrapping-it-up" class="header-anchor no-hover-padding" href=#wrapping-it-up><span aria-hidden=true class=link-icon></span></a> Wrapping it up</h1><p>In this first part of our tutorial, we have laid a solid foundation by setting up a production-ready EKS cluster on AWS. We have configured essential components such as Karpenter for auto-scaling, NodeLocal DNS Cache for reliable DNS resolution, and Traefik with Cert Manager for secure external access. This setup ensures that our infrastructure is both scalable and secure, ready to handle high computational workloads typical in Data and ML applications.<hr><p>In the next chapter, we will delve into the installation and configuration of ArgoCD, a powerful GitOps continuous delivery tool for Kubernetes. ArgoCD will enable us to manage our Kubernetes applications declaratively, ensuring consistent and automated deployment workflows, specifically for Branch Deployments. We will then use ArgoCD to deploy Dagster.<hr><h1 id=footnotes><a aria-label="Anchor link for: footnotes" class="header-anchor no-hover-padding" href=#footnotes><span aria-hidden=true class=link-icon></span></a> Footnotes</h1><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p>While this tutorial is tailored for AWS, only Karpenter from all the used tools is AWS-specific. However, Karpeneter is aiming to support other clouds in the future.</div><div class=footnote-definition id=2><sup class=footnote-definition-label>2</sup><p>The only required proprietary component is AWS EKS itselt.</div></section><nav class="full-width article-navigation"><div><a aria-describedby=left_title aria-label=Next href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-2/><span class=arrow>←</span> Next</a><p aria-hidden=true id=left_title>Cloud Computing with EKS: Dagster with ArgoCD</div><div><a aria-describedby=right_title aria-label=Prev href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/custom-dagster-asset-decorator/>Prev <span class=arrow>→</span></a><p aria-hidden=true id=right_title>Unlocking Flexible Pipelines: Customizing the Asset Decorator</div></nav><div class=comments data-category=Announcements data-category-id=DIC_kwDOLfTdus4CePI8 data-dark-theme=noborder_dark data-input-position=top data-lang=en data-lazy-loading=true data-light-theme=noborder_light data-mapping=specific data-reactions-enabled=1 data-repo=danielgafni/website data-repo-id=R_kgDOLfTdug data-strict=1 data-term=cloud-computing-eks-part-1 id=comments><script async src=https://danielgafni.github.io/website/pr-preview/pr-25/js/giscus.min.js></script><noscript>You need JavaScript to view the comments.</noscript></div></article></main><div id=button-container><div id=toc-floating-container><input class=toggle id=toc-toggle type=checkbox><label class=overlay for=toc-toggle></label><label title="Toggle Table of Contents" class=button for=toc-toggle id=toc-button><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg></label><div class=toc-content><div class=toc-container><ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#introduction>Introduction</a> <ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#prerequisites>Prerequisites</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#goals-tools>Goals & Tools</a></ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#who-scales-the-autoscaler>Who scales the autoscaler?</a> <ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#creating-nodepools-with-karpenter>Creating NodePools with Karpenter</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#gpu-nodes>GPU nodes</a></ul><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#dns-caching>DNS caching</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#cloud-district>Cloud District</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#wrapping-it-up>Wrapping it up</a><li><a href=https://danielgafni.github.io/website/pr-preview/pr-25/blog/cloud-computing-eks-part-1/#footnotes>Footnotes</a></ul></div></div></div><a title="Go to the comments section" class=no-hover-padding href=#comments id=comments-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule=evenodd fill-rule=evenodd /></svg> </a><a title="Go to the top of the page" class=no-hover-padding href=# id=top-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://danielgafni.github.io/website/pr-preview/pr-25/js/copyCodeToClipboard.min.js></script><script defer src=https://danielgafni.github.io/website/pr-preview/pr-25/js/codeBlockNameLinks.min.js></script><script defer src=https://danielgafni.github.io/website/pr-preview/pr-25/js/footnoteBacklinks.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://danielgafni.github.io/website/pr-preview/pr-25/atom.xml> <img alt=feed loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-25/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email=ZGFuaWVsZ2FmbmkxNkBnbWFpbC5jb20K href=#><img alt=email loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-25/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/danielgafni> <img alt=github loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-25/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://gitlab.com/danielgafni> <img alt=gitlab loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-25/social_icons/gitlab.svg title=gitlab> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://www.linkedin.com/in/danielgafni/> <img alt=linkedin loading=lazy src=https://danielgafni.github.io/website/pr-preview/pr-25/social_icons/linkedin.svg title=linkedin> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> <p><p>UNLICENSED 2025 Daniel Gafni • The contents of this website are free to use</p> Powered by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> • <a href=https://github.com/danielgafni/website> Site source </a></small></div></section><script async src=https://danielgafni.github.io/website/pr-preview/pr-25/js/decodeMail.min.js></script><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search… role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>